<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ExpireMe ‚Äî Home</title>
  <style>
    :root{
      --bg:#f6fafb; --card:#ffffff; --muted:#6b7280; --accent:#138496; --accent-2:#2b7cff;
      --danger:#d9534f; --success:#0f5132; --glass: rgba(19,128,140,0.06);
      --radius:12px; --container:1100px;
      --shadow:0 8px 20px rgba(23,43,77,0.08);
      --bronze: #cd7f32; --silver: #c0c0c0; --gold: #ffd700;
    }
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#f0f7f8 0%,var(--bg)100%);color:#21303b}
    .wrap{max-width:var(--container);margin:28px auto;padding:20px;display:flex;gap:20px;align-items:flex-start;padding-bottom:120px} /* Added bottom padding */
    .main{flex:1;display:flex;flex-direction:column;gap:18px}
    .sidebar{width:320px;display:flex;flex-direction:column;gap:18px}
    header.top{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:transparent;position:relative}
    .profile{display:flex;align-items:center;gap:12px}
    .avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#ffe9c6,#ffd7a8);display:flex;align-items:center;justify-content:center;font-weight:700;color:#7a4b08}
    .greeting{font-size:18px;font-weight:600}
    .icons{display:flex;gap:12px;align-items:center}
    .icon-btn{width:36px;height:36px;border-radius:8px;display:inline-grid;place-items:center;background:var(--card);box-shadow:var(--shadow);cursor:pointer;border:none;font-size:16px}
    .hero{background:linear-gradient(180deg,#0fa3a7 0%,#137b7c 100%);color:#fff;padding:20px;border-radius:14px;box-shadow:var(--shadow);display:flex;gap:18px;align-items:center}
    .hero .text{flex:1}
    .hero h2{margin:0 0 6px;font-size:20px}
    .hero p{margin:0;font-size:13px;opacity:0.95}
    .thumbs{display:flex;gap:10px}
    .thumb{width:86px;height:70px;border-radius:10px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .section-title{text-align:center;padding:8px 0}
    .section-title .date{font-size:12px;color:var(--muted);margin-bottom:6px}
    .section-title h3{margin:0;font-size:20px}
    .stats{display:flex;gap:12px;align-items:center;justify-content:center}
    .stat{background:var(--card);padding:12px 18px;border-radius:999px;box-shadow:var(--shadow);min-width:120px;text-align:center;cursor:pointer}
    .stat .num{font-size:20px;font-weight:700}
    .stat .label{font-size:12px;color:var(--muted)}
    .stat.active{background:linear-gradient(90deg,#e6f7f7,#f1fcfe);border:1px solid rgba(19,128,140,0.08)}
    .list{background:var(--card);padding:18px;border-radius:14px;box-shadow:var(--shadow);min-height:320px;max-height:500px;overflow-y:auto} /* Added overflow */
    .item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfeff);box-shadow:0 4px 12px rgba(16,54,63,0.04);margin-bottom:10px}
    .item:last-child{margin-bottom:0}
    .item .img{width:56px;height:56px;border-radius:10px;background:var(--glass);display:flex;align-items:center;justify-content:center;font-weight:600;color:#6b7280}
    .item .meta{flex:1}
    .item .meta .title{font-weight:600;margin-bottom:4px}
    .item .meta .sub{font-size:13px;color:var(--muted)}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px}
    .badge.expired{background:rgba(217,83,79,0.08);color:var(--danger)}
    .badge.soon{background:rgba(255,171,0,0.08);color:#ff8c00}
    .badge.fresh{background:rgba(15,81,50,0.08);color:var(--success)}
    .check{width:36px;height:36px;border-radius:50%;border:2px solid #e6eef0;display:grid;place-items:center;color:var(--accent-2);cursor:pointer}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow)}
    .small-title{font-size:13px;color:var(--muted);margin-bottom:8px}
    .recipe-grid{display:flex;flex-direction:column;gap:8px}
    .recipe{display:flex;gap:10px;align-items:center;cursor:pointer;padding:8px;border-radius:8px;transition:background-color 0.2s}
    .recipe:hover{background-color:#f8fafb}
    .recipe .rimg{width:64px;height:48px;border-radius:8px;background:#f0f4f5;display:block;object-fit:cover}
    .search{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--card);border-radius:999px;box-shadow:var(--shadow);margin:12px 0}
    .search input{border:0;outline:0;width:100%;font-size:14px;background:transparent}
    .tabs{display:flex;gap:12px;padding:8px}
    .tab{padding:8px 12px;border-radius:999px;cursor:pointer;color:var(--muted);background:transparent}
    .tab.active{background:linear-gradient(90deg,#e6f7f7,#f1fcfe);color:var(--accent-2);font-weight:600;box-shadow:var(--shadow)}
    .storage-list{background:linear-gradient(180deg,#eaf9f9,#ffffff);padding:14px;border-radius:14px;max-height:500px;overflow-y:auto} /* Added overflow */
    .storage-item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;background:var(--card);border-radius:10px;margin-bottom:10px;box-shadow:0 6px 14px rgba(16,54,63,0.03)}
    .storage-item .left{display:flex;gap:12px;align-items:center}
    .progress{width:44px;height:44px;border-radius:50%;background:linear-gradient(180deg,#fff,#fbfeff);display:grid;place-items:center;border:6px solid rgba(255,171,0,0.08)}
    .storage-item .meta .sub{font-weight:700;color:#111}
    .recipe-grid-page{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px;padding:12px 0;max-height:500px;overflow-y:auto} /* Added overflow */
    .recipe-card{background:var(--card);border-radius:14px;overflow:hidden;box-shadow:var(--shadow);cursor:pointer;transition:transform 0.2s}
    .recipe-card:hover{transform:translateY(-4px)}
    .recipe-card .img{width:100%;height:140px;object-fit:cover;display:block}
    .recipe-card .info{padding:10px}
    .recipe-card .title{font-weight:600;font-size:14px;margin-bottom:6px}
    .recipe-card .time{display:flex;align-items:center;gap:4px;font-size:12px;color:var(--muted);margin-bottom:8px}
    .recipe-card .heart{cursor:pointer;font-size:18px}
    .recipe-back{display:flex;align-items:center;gap:8px;background:none;border:0;color:var(--accent-2);cursor:pointer;padding:8px 0;font-size:14px;margin-bottom:12px}
    .bottom-nav{position:fixed;left:0;right:0;bottom:18px;pointer-events:none;display:flex;justify-content:center;z-index:60}
    .bottom-nav-inner{width:100%;max-width:var(--container);padding:0 18px;display:flex;align-items:center;justify-content:space-between;gap:12px;pointer-events:auto}
    .nav-group{display:flex;gap:0;align-items:center;flex:1;justify-content:space-around}
    .nav-pill{flex:1;display:flex;align-items:center;justify-content:space-between;gap:0;background:#4FB7B3;padding:10px 14px;border-radius:14px;box-shadow:var(--shadow)}
    .nav-btn{display:flex;flex-direction:column;align-items:center;gap:4px;background:transparent;border:0;padding:6px 8px;cursor:pointer;color:#fff;font-size:13px;flex:1}
    .nav-btn .icon{font-size:18px;display:block}
    .nav-btn.active{color:#fff;font-weight:600}
    .fab{width:64px;height:64px;border-radius:50%;background:linear-gradient(90deg,#ffb84d,#ff8c42);display:grid;place-items:center;color:#fff;font-size:28px;margin-top:-28px;box-shadow:0 12px 30px rgba(255,140,66,0.18);border:6px solid #4FB7B3;cursor:pointer}
    
    /* Settings Dropdown */
    .settings-container {
      position: relative;
      display: inline-block;
    }
    
    .settings-dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      background: var(--card);
      border-radius: 12px;
      box-shadow: var(--shadow);
      min-width: 160px;
      z-index: 1000;
      margin-top: 8px;
      overflow: hidden;
    }
    
    .settings-dropdown.show {
      display: block;
    }
    
    .dropdown-item {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      border: none;
      width: 100%;
      background: none;
      text-align: left;
      font-size: 14px;
      color: #21303b;
      transition: background-color 0.2s;
    }
    
    .dropdown-item:hover {
      background-color: #f8fafb;
    }
    
    .dropdown-item.logout {
      color: var(--danger);
    }
    
    .dropdown-divider {
      height: 1px;
      background: #e6eef0;
      margin: 4px 0;
    }
    
    /* Add Item Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 20px;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background: var(--card);
      border-radius: 14px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
    }
    
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e6eef0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }
    
    .modal-close:hover {
      background: #f0f4f5;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e3e7ee;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    .form-input:focus, .form-select:focus {
      outline: 0;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(43,124,255,0.08);
    }
    
    .form-row {
      display: flex;
      gap: 12px;
    }
    
    .form-row .form-group {
      flex: 1;
    }
    
    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .btn {
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: opacity 0.2s;
    }
    
    .btn:hover {
      opacity: 0.9;
    }
    
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    
    .btn-secondary {
      background: #f0f4f5;
      color: var(--muted);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .form-message {
      margin-top: 12px;
      font-size: 13px;
      min-height: 18px;
      padding: 8px 12px;
      border-radius: 6px;
    }
    
    .form-message.error {
      color: var(--danger);
      background: rgba(217,83,79,0.08);
    }
    
    .form-message.success {
      color: var(--success);
      background: rgba(15,81,50,0.08);
    }
    
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .empty-state {
      text-align: center;
      color: var(--muted);
      padding: 60px 20px;
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-state p {
      margin: 8px 0;
      font-size: 14px;
    }
    
    /* Recipe Detail Styles */
    .recipe-detail {
      background: var(--card);
      border-radius: 14px;
      padding: 20px;
      box-shadow: var(--shadow);
      max-height: 500px;
      overflow-y: auto; /* Added overflow */
    }
    
    .recipe-detail-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .recipe-detail-title {
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 8px 0;
      color: #21303b;
    }
    
    .recipe-detail-meta {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      color: var(--muted);
      font-size: 14px;
    }
    
    .recipe-detail-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .recipe-section {
      margin-bottom: 24px;
    }
    
    .recipe-section-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #f0f4f5;
    }
    
    .ingredients-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .ingredient-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      background: #f8fafb;
      border-radius: 8px;
    }
    
    .ingredient-check {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid #e3e7ee;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--success);
      cursor: pointer;
      flex-shrink: 0;
    }
    
    .ingredient-check.available {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }
    
    .ingredient-check.unavailable {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }
    
    .ingredient-details {
      flex: 1;
    }
    
    .ingredient-name {
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .ingredient-quantity {
      font-size: 13px;
      color: var(--muted);
    }
    
    .ingredient-status {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
    }
    
    .ingredient-status.available {
      background: rgba(15,81,50,0.1);
      color: var(--success);
    }
    
    .ingredient-status.unavailable {
      background: rgba(217,83,79,0.1);
      color: var(--danger);
    }
    
    .instructions-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding-left: 20px;
    }
    
    .instruction-step {
      position: relative;
      padding-left: 8px;
    }
    
    .instruction-number {
      position: absolute;
      left: -28px;
      top: 0;
      width: 20px;
      height: 20px;
      background: var(--accent);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }
    
    .recipe-cost {
      background: linear-gradient(180deg,#eaf9f9,#ffffff);
      padding: 16px;
      border-radius: 12px;
      margin-top: 20px;
    }
    
    .cost-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .cost-total {
      font-weight: 700;
      font-size: 18px;
      color: var(--success);
      border-top: 2px solid #f0f4f5;
      padding-top: 12px;
      margin-top: 12px;
    }
    
    .cook-button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(90deg,#ffb84d,#ff8c42);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      margin-top: 20px;
    }
    
    .cook-button:hover:not(:disabled) {
      transform: translateY(-2px);
    }
    
    .cook-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Food status indicators */
    .food-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-fresh {
      background: rgba(15,81,50,0.1);
      color: var(--success);
    }
    
    .status-soon {
      background: rgba(255,171,0,0.1);
      color: #ff8c00;
    }
    
    .status-expired {
      background: rgba(217,83,79,0.1);
      color: var(--danger);
    }
    
    /* REWARDS/ACHIEVEMENTS STYLES - IMPROVED */
    .achievements-container {
      display: flex;
      flex-direction: column;
      gap: 24px;
      max-height: 500px;
      overflow-y: auto; /* Added overflow */
      padding-right: 8px;
    }
    
    .achievement-category {
      background: var(--card);
      border-radius: 14px;
      padding: 20px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }
    
    .category-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f4f5;
    }
    
    .category-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
    }
    
    .category-title {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
      color: #21303b;
    }
    
    .category-description {
      font-size: 14px;
      color: var(--muted);
      margin: 4px 0 0 0;
    }
    
    .achievement-card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      margin-bottom: 12px;
      position: relative;
    }
    
    .achievement-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(23,43,77,0.12);
    }
    
    .achievement-card.locked {
      opacity: 0.7;
      background: linear-gradient(135deg, #f8fafb, #ffffff);
    }
    
    .achievement-card.unlocked {
      border-color: var(--accent);
      background: linear-gradient(135deg, #ffffff, #f8fdfe);
    }
    
    .achievement-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
      position: relative;
    }
    
    .achievement-bronze {
      background: linear-gradient(135deg, var(--bronze), #e6b85c);
      color: white;
    }
    
    .achievement-silver {
      background: linear-gradient(135deg, var(--silver), #e0e0e0);
      color: white;
    }
    
    .achievement-gold {
      background: linear-gradient(135deg, var(--gold), #ffed4e);
      color: white;
    }
    
    .achievement-info {
      flex: 1;
    }
    
    .achievement-name {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 6px;
      color: #21303b;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .achievement-desc {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 12px;
      line-height: 1.4;
    }
    
    .achievement-requirements {
      font-size: 12px;
      color: var(--muted);
      background: #f8fafb;
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 3px solid var(--accent);
    }
    
    .achievement-progress {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
    }
    
    .progress-bar {
      flex: 1;
      height: 8px;
      background: #e6eef0;
      border-radius: 999px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border-radius: 999px;
      transition: width 0.3s ease;
    }
    
    .progress-text {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
      min-width: 70px;
      text-align: right;
    }
    
    .achievement-status {
      font-size: 12px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
      margin-left: auto;
    }
    
    .status-unlocked {
      background: rgba(15,81,50,0.1);
      color: var(--success);
    }
    
    .status-locked {
      background: rgba(108,117,125,0.1);
      color: var(--muted);
    }
    
    .achievement-xp {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: linear-gradient(135deg, #ffb84d, #ff8c42);
      color: white;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .unlocked-date {
      font-size: 11px;
      color: var(--muted);
      font-style: italic;
      margin-top: 4px;
    }
    
    .rewards-header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #0fa3a7, #137b7c);
      border-radius: 14px;
      color: white;
      box-shadow: var(--shadow);
    }
    
    .rewards-header h2 {
      margin: 0 0 8px 0;
      font-size: 28px;
      color: white;
    }
    
    .rewards-header p {
      margin: 0;
      opacity: 0.9;
      font-size: 15px;
    }
    
    .rewards-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: var(--card);
      padding: 20px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      text-align: center;
      transition: transform 0.2s;
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
    }
    
    .stat-icon {
      font-size: 24px;
      margin-bottom: 12px;
      opacity: 0.8;
    }
    
    .stat-number {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 6px;
      color: #21303b;
    }
    
    .stat-label {
      font-size: 13px;
      color: var(--muted);
      font-weight: 500;
    }
    
    .level-info {
      display: flex;
      align-items: center;
      gap: 16px;
      background: linear-gradient(135deg, #eaf9f9, #ffffff);
      padding: 20px;
      border-radius: 14px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }
    
    .level-display {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffb84d, #ff8c42);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 800;
      color: white;
      flex-shrink: 0;
    }
    
    .level-details {
      flex: 1;
    }
    
    .level-title {
      font-size: 18px;
      font-weight: 700;
      margin: 0 0 8px 0;
      color: #21303b;
    }
    
    .level-progress {
      margin: 12px 0;
    }
    
    .level-progress-bar {
      height: 8px;
      background: #e6eef0;
      border-radius: 999px;
      overflow: hidden;
    }
    
    .level-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ffb84d, #ff8c42);
      border-radius: 999px;
    }
    
    .level-next {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
    }
    
    .achievement-new {
      position: absolute;
      top: -6px;
      right: -6px;
      background: var(--danger);
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 999px;
      animation: pulse 2s infinite;
      z-index: 2;
    }
    
    .tier-indicator {
      position: absolute;
      bottom: -4px;
      right: -4px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      border: 2px solid white;
    }
    
    .tier-bronze {
      background: var(--bronze);
      color: white;
    }
    
    .tier-silver {
      background: var(--silver);
      color: white;
    }
    
    .tier-gold {
      background: var(--gold);
      color: white;
    }
    
    .how-to-unlock {
      margin-top: 24px;
      padding: 20px;
      background: linear-gradient(135deg, #f8fdfe, #ffffff);
      border-radius: 14px;
      box-shadow: var(--shadow);
    }
    
    .how-to-unlock h3 {
      font-size: 18px;
      font-weight: 700;
      margin: 0 0 16px 0;
      color: #21303b;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tips-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .tip-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      border-left: 4px solid var(--accent);
    }
    
    .tip-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--accent);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    
    .tip-content {
      flex: 1;
    }
    
    .tip-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      color: #21303b;
    }
    
    .tip-desc {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.4;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .notification-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--card);
      padding: 16px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      transform: translateX(120%);
      transition: transform 0.3s ease;
      max-width: 350px;
      border-left: 4px solid var(--accent);
    }
    
    .notification-toast.show {
      transform: translateX(0);
    }
    
    .notification-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      flex-shrink: 0;
    }
    
    /* Notification Page Styles */
    .notification-header {
      text-align: center;
      margin-bottom: 24px;
    }
    
    .notification-header h2 {
      margin: 0 0 8px 0;
      font-size: 24px;
      color: #21303b;
    }
    
    .notification-header p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }
    
    .notification-card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: flex-start;
      gap: 12px;
      border-left: 4px solid transparent;
      transition: transform 0.2s;
    }
    
    .notification-card:hover {
      transform: translateY(-2px);
    }
    
    .notification-card.unread {
      border-left-color: var(--accent);
      background: linear-gradient(135deg, #f8fdfe, #ffffff);
    }
    
    .notification-card.expired {
      border-left-color: var(--danger);
    }
    
    .notification-card.soon {
      border-left-color: #ff8c00;
    }
    
    .notification-card.recipe {
      border-left-color: var(--success);
    }
    
    .notification-card.achievement {
      border-left-color: #ffb84d;
    }
    
    .notification-icon-small {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    
    .notification-icon-expired {
      background: rgba(217,83,79,0.1);
      color: var(--danger);
    }
    
    .notification-icon-soon {
      background: rgba(255,171,0,0.1);
      color: #ff8c00;
    }
    
    .notification-icon-recipe {
      background: rgba(15,81,50,0.1);
      color: var(--success);
    }
    
    .notification-icon-achievement {
      background: rgba(255,184,77,0.1);
      color: #ff8c00;
    }
    
    .notification-icon-info {
      background: rgba(19,128,140,0.1);
      color: var(--accent);
    }
    
    .notification-content {
      flex: 1;
    }
    
    .notification-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 15px;
      color: #21303b;
    }
    
    .notification-message {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
      line-height: 1.4;
    }
    
    .notification-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--muted);
    }
    
    .notification-time {
      font-size: 11px;
      opacity: 0.7;
    }
    
    .notification-actions {
      display: flex;
      gap: 8px;
    }
    
    .notification-action-btn {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .notification-action-btn.view {
      background: rgba(19,128,140,0.1);
      color: var(--accent);
    }
    
    .notification-action-btn.view:hover {
      background: rgba(19,128,140,0.2);
    }
    
    .notification-action-btn.dismiss {
      background: rgba(108,117,125,0.1);
      color: var(--muted);
    }
    
    .notification-action-btn.dismiss:hover {
      background: rgba(108,117,125,0.2);
    }
    
    .notification-filters {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .notification-filter {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      background: #f0f4f5;
      color: var(--muted);
      border: none;
      transition: all 0.2s;
    }
    
    .notification-filter.active {
      background: var(--accent);
      color: white;
    }
    
    .notification-filter:hover:not(.active) {
      background: #e6eef0;
    }
    
    .notification-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    
    .notification-empty .icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    @media (max-width:1000px){
      .wrap{padding:12px;flex-direction:column}
      .sidebar{width:100%}
      .rewards-stats {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    @media (max-width:700px){
      .bottom-nav{bottom:12px}
      .fab{width:56px;height:56px;margin-top:-24px;font-size:24px}
      .nav-btn{font-size:12px}
      .form-row {
        flex-direction: column;
        gap: 16px;
      }
      .recipe-detail-title {
        font-size: 20px;
      }
      .rewards-stats {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }
      .stat-card {
        padding: 16px;
      }
      .stat-number {
        font-size: 24px;
      }
      .level-info {
        flex-direction: column;
        text-align: center;
      }
      .achievement-card {
        flex-direction: column;
        text-align: center;
        padding: 20px;
      }
      .achievement-progress {
        flex-direction: column;
        gap: 8px;
      }
      .progress-text {
        text-align: center;
      }
      .category-header {
        flex-direction: column;
        text-align: center;
        gap: 16px;
      }
    }
    @media (max-width:500px){
      .rewards-stats {
        grid-template-columns: 1fr;
      }
      .stat-card {
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap" role="main" aria-label="ExpireMe Home">
    <div class="main">
      <header class="top" aria-hidden="false">
        <div class="profile">
          <div class="avatar" title="Profile" id="userAvatar">K</div>
          <div>
            <div class="greeting" id="userGreeting">Hi User</div>
            <div style="font-size:12px;color:var(--muted)">Welcome back</div>
          </div>
        </div>
        <div class="icons">
          <button class="icon-btn" title="Notifications" id="btnBell">üîî</button>
          <div class="settings-container">
            <button class="icon-btn" title="Settings" id="btnSettings">‚öôÔ∏è</button>
            <div class="settings-dropdown" id="settingsDropdown">
              <button class="dropdown-item" id="btnLogout">
                <span>üö™</span> Logout
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- HOME VIEW -->
      <div id="view-home" aria-live="polite">
        <section class="hero" aria-label="Food reminder">
          <div class="text">
            <h2 id="heroTitle">Manage Your Food Items</h2>
            <p id="heroSubtitle">Add items to track their expiry dates</p>
          </div>
        </section>

        <section class="section-title" aria-labelledby="title-check">
          <div class="date" id="currentDate">Loading date...</div>
          <h3 id="title-check">Check Your Food Stock!</h3>
        </section>

        <nav class="stats" role="tablist" aria-label="Stock categories">
          <div class="stat active" data-type="expired" role="tab" aria-selected="true">
            <div class="num" id="expiredCount">0</div>
            <div class="label">Expired</div>
          </div>
          <div class="stat" data-type="soon" role="tab" aria-selected="false">
            <div class="num" id="soonCount">0</div>
            <div class="label">Expiring Soon</div>
          </div>
          <div class="stat" data-type="fresh" role="tab" aria-selected="false">
            <div class="num" id="freshCount">0</div>
            <div class="label">Fresh</div>
          </div>
        </nav>

        <section class="list" id="list">
          <div class="empty-state">
            <div class="icon">üì¶</div>
            <p>No items yet</p>
            <p>Add your first item to get started!</p>
          </div>
        </section>
      </div>

      <!-- STORAGE VIEW -->
      <div id="view-storage" style="display:none">
        <div style="text-align:center;margin-top:6px;color:var(--muted);font-size:13px" id="storageDate">Loading date...</div>
        <h3 style="text-align:center;margin:6px 0 10px">Your Storage</h3>

        <div class="search" role="search" aria-label="Search ingredients">
          <span>üîç</span>
          <input id="storage-search" placeholder="Search your items..." />
        </div>

        <div class="tabs" role="tablist" aria-label="Storage tabs">
          <div class="tab active" data-loc="fridge" role="tab">Fridge</div>
          <div class="tab" data-loc="freezer" role="tab">Freezer</div>
          <div class="tab" data-loc="pantry" role="tab">Pantry</div>
        </div>

        <div class="storage-list" id="storage-list">
          <div class="empty-state">
            <div class="icon">üì¶</div>
            <p>No items in this storage</p>
            <p>Add items to see them here</p>
          </div>
        </div>
      </div>

      <!-- RECIPE VIEW -->
      <div id="view-recipe" style="display:none">
        <div id="recipe-list-view">
          <button class="recipe-back" id="recipe-back">‚Üê Back</button>
          <h3 style="text-align:center;margin:0 0 12px">Recipes</h3>
          <div class="recipe-grid-page" id="recipe-grid">
            <div class="empty-state">
              <div class="icon">üìö</div>
              <p>Loading recipes...</p>
              <p>Checking your pantry for ingredients...</p>
            </div>
          </div>
        </div>

        <div id="recipe-detail-view" style="display:none">
          <button class="recipe-back" id="recipe-detail-back">‚Üê Back to Recipes</button>
          <div class="recipe-detail" id="recipe-detail-content"></div>
        </div>
      </div>

      <!-- REWARDS/ACHIEVEMENTS VIEW - IMPROVED -->
      <div id="view-reward" style="display:none">
        <div class="rewards-header">
          <h2>üèÜ Your Achievements</h2>
          <p>Complete challenges to earn badges, XP, and level up!</p>
        </div>

        <div class="level-info">
          <div class="level-display" id="levelDisplay">1</div>
          <div class="level-details">
            <div class="level-title">Level <span id="levelNumber">1</span> Explorer</div>
            <div class="level-progress">
              <div class="level-progress-bar">
                <div class="level-progress-fill" id="levelProgressFill" style="width: 0%"></div>
              </div>
              <div class="level-next">
                <span id="currentXP">0</span> XP
                <span id="nextLevelXP">100 XP for next level</span>
              </div>
            </div>
          </div>
        </div>

        <div class="rewards-stats">
          <div class="stat-card">
            <div class="stat-icon">‚≠ê</div>
            <div class="stat-number" id="totalXP">0</div>
            <div class="stat-label">Total XP Earned</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üèÖ</div>
            <div class="stat-number" id="unlockedCount">0</div>
            <div class="stat-label">Badges Unlocked</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìà</div>
            <div class="stat-number" id="totalAchievements">20</div>
            <div class="stat-label">Total Achievements</div>
          </div>
        </div>

        <div class="how-to-unlock">
          <h3>üí° How to Unlock Achievements</h3>
          <div class="tips-list">
            <div class="tip-item">
              <div class="tip-icon">üì¶</div>
              <div class="tip-content">
                <div class="tip-title">Track Your Inventory</div>
                <div class="tip-desc">Add food items regularly and mark them as used when consumed</div>
              </div>
            </div>
            <div class="tip-item">
              <div class="tip-icon">üç≥</div>
              <div class="tip-content">
                <div class="tip-title">Cook with Expiring Items</div>
                <div class="tip-desc">Use recipes that include items expiring soon to earn bonus XP</div>
              </div>
            </div>
            <div class="tip-item">
              <div class="tip-icon">üî•</div>
              <div class="tip-content">
                <div class="tip-title">Maintain Streaks</div>
                <div class="tip-desc">Use the app daily and add items consistently to build streaks</div>
              </div>
            </div>
          </div>
        </div>

        <div class="achievements-container" id="achievements-container">
          <!-- Inventory Management -->
          <div class="achievement-category">
            <div class="category-header">
              <div class="category-icon">üì¶</div>
              <div>
                <h3 class="category-title">Inventory Management</h3>
                <p class="category-description">Track and manage your food inventory efficiently</p>
              </div>
            </div>
            <div class="achievements-grid" id="inventory-achievements">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>

          <!-- Cooking & Recipes -->
          <div class="achievement-category">
            <div class="category-header">
              <div class="category-icon">üç≥</div>
              <div>
                <h3 class="category-title">Cooking & Recipes</h3>
                <p class="category-description">Cook recipes and make the most of your ingredients</p>
              </div>
            </div>
            <div class="achievements-grid" id="cooking-achievements">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>

          <!-- Consistency & Streaks -->
          <div class="achievement-category">
            <div class="category-header">
              <div class="category-icon">üî•</div>
              <div>
                <h3 class="category-title">Consistency & Streaks</h3>
                <p class="category-description">Build habits by using the app regularly</p>
              </div>
            </div>
            <div class="achievements-grid" id="streak-achievements">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>

          <!-- Special Challenges -->
          <div class="achievement-category">
            <div class="category-header">
              <div class="category-icon">üéØ</div>
              <div>
                <h3 class="category-title">Special Challenges</h3>
                <p class="category-description">Complete special challenges for extra rewards</p>
              </div>
            </div>
            <div class="achievements-grid" id="special-achievements">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <!-- NOTIFICATION VIEW -->
      <div id="view-notification" style="display:none">
        <div class="notification-header">
          <h2>üîî Notifications</h2>
          <p>Stay updated with your food items, recipes, and achievements</p>
        </div>

        <div class="notification-filters" id="notification-filters">
          <button class="notification-filter active" data-filter="all">All</button>
          <button class="notification-filter" data-filter="expired">Expired Items</button>
          <button class="notification-filter" data-filter="soon">Expiring Soon</button>
          <button class="notification-filter" data-filter="recipe">Recipe Suggestions</button>
          <button class="notification-filter" data-filter="achievement">Achievements</button>
        </div>

        <div id="notifications-list" style="max-height:500px;overflow-y:auto">
          <div class="empty-state">
            <div class="icon">üîî</div>
            <p>No notifications yet</p>
            <p>Notifications will appear here based on your pantry items and activities</p>
          </div>
        </div>
      </div>
    </div>

    <aside class="sidebar" aria-label="Right column">
      <div class="card">
        <div class="small-title">Summary</div>
        <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
          <div>
            <div style="font-size:22px;font-weight:700" id="summaryExpired">0</div>
            <div style="font-size:12px;color:var(--muted)">Expired</div>
          </div>
          <div>
            <div style="font-size:22px;font-weight:700" id="summarySoon">0</div>
            <div style="font-size:12px;color:var(--muted)">Expiring Soon</div>
          </div>
          <div>
            <div style="font-size:22px;font-weight:700" id="summaryFresh">0</div>
            <div style="font-size:12px;color:var(--muted)">Fresh</div>
          </div>
        </div>
      </div>

      <!-- Dynamic Suggestions Card -->
      <div class="card">
        <div class="small-title">Suggestions</div>
        <div style="font-size:14px;margin-bottom:8px" id="suggestionsSubtitle">Try these recipes with items that are expiring soon</div>
        <div class="recipe-grid" id="suggestions-list">
          <div class="empty-state" style="padding:20px 0;min-height:auto">
            <div class="icon">üç≥</div>
            <p>No recipes to suggest yet</p>
            <p style="font-size:12px">Add more items to get personalized suggestions</p>
          </div>
        </div>
      </div>

      <!-- Recent Achievements Card -->
      <div class="card">
        <div class="small-title">Recent Achievements</div>
        <div class="recipe-grid" id="recent-achievements">
          <div class="empty-state" style="padding:20px 0;min-height:auto">
            <div class="icon">üèÜ</div>
            <p>No achievements yet</p>
            <p style="font-size:12px">Complete challenges to earn badges</p>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- ADD ITEM MODAL -->
  <div class="modal-overlay" id="addItemModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Add New Item</h2>
        <button class="modal-close" id="modalClose">√ó</button>
      </div>
      <div class="modal-body">
        <form id="addItemForm">
          <div class="form-group">
            <label class="form-label" for="itemName">Item Name</label>
            <input type="text" class="form-input" id="itemName" placeholder="e.g. Milk, Eggs, Bread" required>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="itemQuantity">Quantity</label>
              <input type="number" class="form-input" id="itemQuantity" min="1" value="1" required>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="itemUnit">Unit</label>
              <select class="form-select" id="itemUnit" required>
                <option value="pieces">Pieces</option>
                <option value="grams">Grams</option>
                <option value="kilograms">Kilograms</option>
                <option value="milliliters">Milliliters</option>
                <option value="liters">Liters</option>
                <option value="ounces">Ounces</option>
                <option value="pounds">Pounds</option>
                <option value="cups">Cups</option>
                <option value="tablespoons">Tablespoons</option>
                <option value="teaspoons">Teaspoons</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="itemLocation">Storage Location</label>
            <select class="form-select" id="itemLocation" required>
              <option value="fridge">Fridge</option>
              <option value="freezer">Freezer</option>
              <option value="pantry">Pantry</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="itemExpiry">Expiry Date</label>
            <input type="date" class="form-input" id="itemExpiry" required>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelAdd">Cancel</button>
            <button type="submit" class="btn btn-primary" id="saveItem">Add Item</button>
          </div>
          
          <div class="form-message" id="formMessage"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- ACHIEVEMENT NOTIFICATION TOAST -->
  <div class="notification-toast" id="achievementToast">
    <div class="notification-icon" id="toastIcon">üèÜ</div>
    <div>
      <div style="font-weight:600;margin-bottom:4px" id="toastTitle">Achievement Unlocked!</div>
      <div style="font-size:13px;color:var(--muted)" id="toastMessage">You've earned a new badge</div>
      <div style="font-size:11px;color:var(--accent);margin-top:4px" id="toastXP">+10 XP</div>
    </div>
    <button style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);margin-left:auto" id="toastClose">√ó</button>
  </div>

  <!-- BOTTOM NAVIGATION -->
  <div class="bottom-nav" role="navigation" aria-label="Main navigation">
    <div class="bottom-nav-inner">
      <div class="nav-pill">
        <div class="nav-group left">
          <button class="nav-btn active" id="nav-home" title="Home"><span class="icon">üè†</span><span class="text">Home</span></button>
          <button class="nav-btn" id="nav-storage" title="Storage"><span class="icon">üì¶</span><span class="text">Storage</span></button>
        </div>

        <button class="fab" id="nav-add" aria-label="Add item">+</button>

        <div class="nav-group right">
          <button class="nav-btn" id="nav-recipe" title="Recipe"><span class="icon">üìö</span><span class="text">Recipe</span></button>
          <button class="nav-btn" id="nav-reward" title="Reward"><span class="icon">üèÜ</span><span class="text">Reward</span></button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  // Import Firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import { 
    getFirestore, 
    collection, 
    addDoc, 
    query, 
    where, 
    orderBy, 
    onSnapshot, 
    serverTimestamp,
    deleteDoc,
    doc,
    updateDoc,
    getDoc,
    getDocs,
    setDoc,
    increment
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBzKv3EIbgpJgo-Is81mBUxvFvt1RctKhk",
    authDomain: "expireme-38849.firebaseapp.com",
    projectId: "expireme-38849",
    storageBucket: "expireme-38849.firebasestorage.app",
    messagingSenderId: "405593756802",
    appId: "1:405593756802:web:ab73386c1c1816a492d09b",
    measurementId: "G-RKTKJHYQZ2"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM Elements
  const listEl = document.getElementById('list');
  const storageListEl = document.getElementById('storage-list');
  const recipeGridEl = document.getElementById('recipe-grid');
  const recipeDetailContent = document.getElementById('recipe-detail-content');
  const recipeListView = document.getElementById('recipe-list-view');
  const recipeDetailView = document.getElementById('recipe-detail-view');
  const stats = document.querySelectorAll('.stat');
  const tabEls = document.querySelectorAll('.tab');
  const storageSearch = document.getElementById('storage-search');
  const navButtons = document.querySelectorAll('.nav-btn');
  const btnBell = document.getElementById('btnBell');
  const btnSettings = document.getElementById('btnSettings');
  const settingsDropdown = document.getElementById('settingsDropdown');
  const btnLogout = document.getElementById('btnLogout');
  const userAvatar = document.getElementById('userAvatar');
  const userGreeting = document.getElementById('userGreeting');
  const currentDateEl = document.getElementById('currentDate');
  const storageDateEl = document.getElementById('storageDate');
  const expiredCountEl = document.getElementById('expiredCount');
  const soonCountEl = document.getElementById('soonCount');
  const freshCountEl = document.getElementById('freshCount');
  const summaryExpiredEl = document.getElementById('summaryExpired');
  const summarySoonEl = document.getElementById('summarySoon');
  const summaryFreshEl = document.getElementById('summaryFresh');
  const heroTitle = document.getElementById('heroTitle');
  const heroSubtitle = document.getElementById('heroSubtitle');
  const recipeBack = document.getElementById('recipe-back');
  const recipeDetailBack = document.getElementById('recipe-detail-back');
  const suggestionsList = document.getElementById('suggestions-list');
  const suggestionsSubtitle = document.getElementById('suggestionsSubtitle');
  const recentAchievementsEl = document.getElementById('recent-achievements');
  const inventoryAchievementsEl = document.getElementById('inventory-achievements');
  const cookingAchievementsEl = document.getElementById('cooking-achievements');
  const streakAchievementsEl = document.getElementById('streak-achievements');
  const specialAchievementsEl = document.getElementById('special-achievements');
  const totalXpEl = document.getElementById('totalXP');
  const unlockedCountEl = document.getElementById('unlockedCount');
  const totalAchievementsEl = document.getElementById('totalAchievements');
  const levelNumberEl = document.getElementById('levelNumber');
  const levelDisplayEl = document.getElementById('levelDisplay');
  const currentXpEl = document.getElementById('currentXP');
  const nextLevelXpEl = document.getElementById('nextLevelXP');
  const levelProgressFill = document.getElementById('levelProgressFill');
  const achievementToast = document.getElementById('achievementToast');
  const toastIcon = document.getElementById('toastIcon');
  const toastTitle = document.getElementById('toastTitle');
  const toastMessage = document.getElementById('toastMessage');
  const toastXP = document.getElementById('toastXP');
  const toastClose = document.getElementById('toastClose');
  
  // Notification elements
  const notificationsList = document.getElementById('notifications-list');
  const notificationFilters = document.getElementById('notification-filters');
  
  // Add Item Modal Elements
  const addItemModal = document.getElementById('addItemModal');
  const navAdd = document.getElementById('nav-add');
  const modalClose = document.getElementById('modalClose');
  const cancelAdd = document.getElementById('cancelAdd');
  const addItemForm = document.getElementById('addItemForm');
  const formMessage = document.getElementById('formMessage');
  const itemExpiry = document.getElementById('itemExpiry');
  const saveItemBtn = document.getElementById('saveItem');

  // State
  let storageActiveLoc = 'fridge';
  let userItems = [];
  let currentUser = null;
  let unsubscribeItems = null;
  let recipes = [];
  let currentRecipeDetail = null;
  let unsubscribeRecipes = null;
  let userAchievements = {};
  let userStats = {};
  let achievements = [];
  let notifications = [];
  let activeNotificationFilter = 'all';
  
  // Achievement Definitions - Enhanced with better descriptions
  const ACHIEVEMENTS = [
    // Inventory Management
    {
      id: 'first_item',
      name: 'First Step',
      description: 'Welcome to ExpireMe! Start your journey by adding your first food item.',
      requirements: 'Add 1 food item to your inventory',
      icon: 'üì¶',
      tier: 'bronze',
      category: 'inventory',
      xp: 10,
      target: 1,
      progressType: 'items_added',
      unlocked: false,
      progress: 0
    },
    {
      id: 'pantry_organizer',
      name: 'Pantry Organizer',
      description: 'Keep your pantry well-stocked and organized.',
      requirements: 'Add 10 items to your pantry',
      icon: 'üóÇÔ∏è',
      tier: 'silver',
      category: 'inventory',
      xp: 25,
      target: 10,
      progressType: 'items_added',
      unlocked: false,
      progress: 0
    },
    {
      id: 'inventory_master',
      name: 'Inventory Master',
      description: 'Become a master of inventory management with a substantial collection.',
      requirements: 'Add 50 items total to your inventory',
      icon: 'üìä',
      tier: 'gold',
      category: 'inventory',
      xp: 100,
      target: 50,
      progressType: 'items_added',
      unlocked: false,
      progress: 0
    },
    {
      id: 'fresh_keeper',
      name: 'Fresh Keeper',
      description: 'Maintain fresh items and prevent food waste.',
      requirements: 'Keep 10 items fresh (not expired)',
      icon: '‚úÖ',
      tier: 'silver',
      category: 'inventory',
      xp: 30,
      target: 10,
      progressType: 'fresh_items',
      unlocked: false,
      progress: 0
    },
    {
      id: 'no_waste',
      name: 'Zero Waste Hero',
      description: 'Reduce food waste by using items before they expire.',
      requirements: 'Use up 10 items before they expire',
      icon: '‚ôªÔ∏è',
      tier: 'gold',
      category: 'inventory',
      xp: 75,
      target: 10,
      progressType: 'items_used',
      unlocked: false,
      progress: 0
    },
    {
      id: 'storage_pro',
      name: 'Storage Pro',
      description: 'Organize your food efficiently across all storage locations.',
      requirements: 'Have items in all 3 storage locations (Fridge, Freezer, Pantry)',
      icon: 'üè¢',
      tier: 'silver',
      category: 'inventory',
      xp: 40,
      target: 3,
      progressType: 'storage_locations',
      unlocked: false,
      progress: 0
    },
    
    // Cooking & Recipes
    {
      id: 'first_recipe',
      name: 'First Recipe',
      description: 'Start your cooking journey with your first recipe.',
      requirements: 'Cook your first recipe using ExpireMe',
      icon: 'üç≥',
      tier: 'bronze',
      category: 'cooking',
      xp: 15,
      target: 1,
      progressType: 'recipes_cooked',
      unlocked: false,
      progress: 0
    },
    {
      id: 'home_chef',
      name: 'Home Chef',
      description: 'Expand your cooking repertoire with different recipes.',
      requirements: 'Cook 5 different recipes',
      icon: 'üë®‚Äçüç≥',
      tier: 'silver',
      category: 'cooking',
      xp: 50,
      target: 5,
      progressType: 'recipes_cooked',
      unlocked: false,
      progress: 0
    },
    {
      id: 'master_chef',
      name: 'Master Chef',
      description: 'Become a true culinary expert with extensive recipe experience.',
      requirements: 'Cook 20 recipes total',
      icon: 'üåü',
      tier: 'gold',
      category: 'cooking',
      xp: 150,
      target: 20,
      progressType: 'recipes_cooked',
      unlocked: false,
      progress: 0
    },
    {
      id: 'ingredient_saver',
      name: 'Ingredient Saver',
      description: 'Prevent food waste by using expiring items in your cooking.',
      requirements: 'Cook a recipe using expiring items',
      icon: '‚è∞',
      tier: 'bronze',
      category: 'cooking',
      xp: 20,
      target: 1,
      progressType: 'expiring_recipes',
      unlocked: false,
      progress: 0
    },
    {
      id: 'recipe_explorer',
      name: 'Recipe Explorer',
      description: 'Discover new recipes and expand your culinary knowledge.',
      requirements: 'View 10 different recipes',
      icon: 'üîç',
      tier: 'silver',
      category: 'cooking',
      xp: 30,
      target: 10,
      progressType: 'recipes_viewed',
      unlocked: false,
      progress: 0
    },
    
    // Consistency & Streaks
    {
      id: 'daily_user',
      name: 'Daily User',
      description: 'Build a habit of checking your food inventory regularly.',
      requirements: 'Use the app for 3 consecutive days',
      icon: 'üî•',
      tier: 'bronze',
      category: 'streak',
      xp: 25,
      target: 3,
      progressType: 'login_streak',
      unlocked: false,
      progress: 0
    },
    {
      id: 'weekly_warrior',
      name: 'Weekly Warrior',
      description: 'Demonstrate consistent commitment to food management.',
      requirements: 'Use the app for 7 consecutive days',
      icon: 'üí™',
      tier: 'silver',
      category: 'streak',
      xp: 75,
      target: 7,
      progressType: 'login_streak',
      unlocked: false,
      progress: 0
    },
    {
      id: 'monthly_master',
      name: 'Monthly Master',
      description: 'Achieve the ultimate consistency in food management.',
      requirements: 'Use the app for 30 consecutive days',
      icon: 'üìÖ',
      tier: 'gold',
      category: 'streak',
      xp: 200,
      target: 30,
      progressType: 'login_streak',
      unlocked: false,
      progress: 0
    },
    {
      id: 'consistent_tracker',
      name: 'Consistent Tracker',
      description: 'Maintain regular updates to your food inventory.',
      requirements: 'Add items for 5 days in a row',
      icon: 'üìù',
      tier: 'silver',
      category: 'streak',
      xp: 60,
      target: 5,
      progressType: 'add_streak',
      unlocked: false,
      progress: 0
    },
    
    // Special Challenges
    {
      id: 'perfect_week',
      name: 'Perfect Week',
      description: 'Achieve zero food waste for an entire week.',
      requirements: 'No expired items for 7 days',
      icon: '‚≠ê',
      tier: 'gold',
      category: 'special',
      xp: 100,
      target: 7,
      progressType: 'no_expired_streak',
      unlocked: false,
      progress: 0
    },
    {
      id: 'quick_cook',
      name: 'Quick Cook',
      description: 'Demonstrate your cooking efficiency and creativity.',
      requirements: 'Cook 3 recipes in one day',
      icon: '‚ö°',
      tier: 'silver',
      category: 'special',
      xp: 80,
      target: 3,
      progressType: 'recipes_one_day',
      unlocked: false,
      progress: 0
    },
    {
      id: 'variety_seeker',
      name: 'Variety Seeker',
      description: 'Explore a wide range of different food types.',
      requirements: 'Add 15 different types of food',
      icon: 'üåà',
      tier: 'gold',
      category: 'special',
      xp: 120,
      target: 15,
      progressType: 'unique_foods',
      unlocked: false,
      progress: 0
    },
    {
      id: 'budget_chef',
      name: 'Budget Chef',
      description: 'Save money by cooking with ingredients you already have.',
      requirements: 'Cook recipes worth $50+ in savings',
      icon: 'üí∞',
      tier: 'gold',
      category: 'special',
      xp: 150,
      target: 50,
      progressType: 'money_saved',
      unlocked: false,
      progress: 0
    }
  ];

  // Set current date
  function updateCurrentDate() {
    const now = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const dateString = now.toLocaleDateString('en-US', options);
    currentDateEl.textContent = dateString;
    storageDateEl.textContent = dateString;
  }

  // Set minimum date for expiry to today
  const today = new Date().toISOString().split('T')[0];
  itemExpiry.min = today;

  // Initialize default recipes
  async function initializeDefaultRecipes() {
    try {
      console.log('Checking for default recipes in Firestore...');
      const recipesRef = collection(db, 'recipes');
      const querySnapshot = await getDocs(recipesRef);
      const existingRecipeIds = new Set();
      querySnapshot.forEach(doc => {
        existingRecipeIds.add(doc.id);
      });
      
      console.log('Existing recipe IDs:', Array.from(existingRecipeIds));
      
    } catch (error) {
      console.error('Error checking default recipes:', error);
    }
  }

  // Show achievement notification
  function showAchievementNotification(achievement) {
    toastIcon.textContent = achievement.icon;
    toastTitle.textContent = 'Achievement Unlocked!';
    toastMessage.textContent = achievement.name;
    toastXP.textContent = `+${achievement.xp} XP`;
    
    achievementToast.classList.add('show');
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      achievementToast.classList.remove('show');
    }, 5000);
  }

  // Calculate level from XP
  function calculateLevel(xp) {
    const level = Math.floor(xp / 100) + 1;
    const nextLevelXp = level * 100;
    const currentLevelXp = (level - 1) * 100;
    const progress = ((xp - currentLevelXp) / 100) * 100;
    
    return { level, progress, nextLevelXp, currentLevelXp };
  }

  // Update level display
  function updateLevelDisplay() {
    const xp = userStats.total_xp || 0;
    const levelInfo = calculateLevel(xp);
    
    levelNumberEl.textContent = levelInfo.level;
    levelDisplayEl.textContent = levelInfo.level;
    currentXpEl.textContent = `${xp} XP`;
    nextLevelXpEl.textContent = `${levelInfo.nextLevelXp} XP for next level`;
    levelProgressFill.style.width = `${levelInfo.progress}%`;
  }

  // Generate notifications based on user's pantry items and activities
  function generateNotifications() {
    notifications = [];
    
    if (!currentUser || userItems.length === 0) {
      return;
    }
    
    const now = new Date();
    
    // 1. Expired items notifications
    const expiredItems = userItems.filter(item => item.status === 'expired');
    if (expiredItems.length > 0) {
      expiredItems.forEach(item => {
        notifications.push({
          id: `expired_${item.id}`,
          type: 'expired',
          title: `Item Expired: ${item.name}`,
          message: `${item.name} expired ${Math.abs(item.days)} day${Math.abs(item.days) !== 1 ? 's' : ''} ago. Consider disposing it.`,
          timestamp: new Date(now.getTime() - Math.random() * 86400000 * 7), // Random time in past 7 days
          unread: true,
          itemId: item.id,
          priority: 'high'
        });
      });
    }
    
    // 2. Items expiring soon notifications
    const soonItems = userItems.filter(item => item.status === 'soon');
    if (soonItems.length > 0) {
      soonItems.forEach(item => {
        notifications.push({
          id: `soon_${item.id}`,
          type: 'soon',
          title: `Item Expiring Soon: ${item.name}`,
          message: `${item.name} expires in ${item.days} day${item.days !== 1 ? 's' : ''}. Use it soon!`,
          timestamp: new Date(now.getTime() - Math.random() * 86400000 * 3), // Random time in past 3 days
          unread: true,
          itemId: item.id,
          priority: 'medium'
        });
      });
    }
    
    // 3. Recipe suggestions based on expiring items
    if (recipes.length > 0 && soonItems.length > 0) {
      const expiringItemNames = soonItems.map(item => item.name.toLowerCase());
      
      recipes.forEach(recipe => {
        if (recipe.ingredients && Array.isArray(recipe.ingredients)) {
          const matchingIngredients = recipe.ingredients.filter(ingredient => 
            expiringItemNames.some(itemName => 
              itemName.includes(ingredient.name.toLowerCase()) ||
              ingredient.name.toLowerCase().includes(itemName)
            )
          );
          
          if (matchingIngredients.length > 0) {
            notifications.push({
              id: `recipe_${recipe.id}`,
              type: 'recipe',
              title: `Recipe Suggestion: ${recipe.name}`,
              message: `Make ${recipe.name} with ${matchingIngredients.length} expiring ingredient${matchingIngredients.length !== 1 ? 's' : ''}`,
              timestamp: new Date(now.getTime() - Math.random() * 86400000 * 5), // Random time in past 5 days
              unread: true,
              recipeId: recipe.id,
              priority: 'medium'
            });
          }
        }
      });
    }
    
    // 4. Achievement notifications
    const unlockedAchievements = achievements.filter(a => a.unlocked);
    unlockedAchievements.forEach(achievement => {
      const unlockedDate = userAchievements[achievement.id]?.unlockedAt;
      if (unlockedDate) {
        notifications.push({
          id: `achievement_${achievement.id}`,
          type: 'achievement',
          title: `Achievement Unlocked: ${achievement.name}`,
          message: achievement.description,
          timestamp: new Date(unlockedDate),
          unread: false,
          achievementId: achievement.id,
          priority: 'low'
        });
      }
    });
    
    // 5. General notifications about pantry status
    const totalItems = userItems.length;
    const freshItems = userItems.filter(item => item.status === 'fresh').length;
    
    if (totalItems > 0) {
      const freshnessPercentage = Math.round((freshItems / totalItems) * 100);
      
      if (freshnessPercentage >= 80) {
        notifications.push({
          id: 'pantry_status_good',
          type: 'info',
          title: 'Great Job! Your pantry is in good shape',
          message: `${freshnessPercentage}% of your items are fresh. Keep up the good work!`,
          timestamp: new Date(now.getTime() - Math.random() * 86400000 * 2),
          unread: true,
          priority: 'low'
        });
      } else if (freshnessPercentage <= 30) {
        notifications.push({
          id: 'pantry_status_low',
          type: 'info',
          title: 'Check your pantry',
          message: `Only ${freshnessPercentage}% of your items are fresh. Consider using or replacing items soon.`,
          timestamp: new Date(now.getTime() - Math.random() * 86400000),
          unread: true,
          priority: 'medium'
        });
      }
    }
    
    // Sort notifications by timestamp (newest first)
    notifications.sort((a, b) => b.timestamp - a.timestamp);
    
    // Update notification badge on bell icon if there are unread notifications
    updateNotificationBadge();
  }

  // Update notification badge on bell icon
  function updateNotificationBadge() {
    const unreadCount = notifications.filter(n => n.unread).length;
    const bellIcon = document.getElementById('btnBell');
    
    if (unreadCount > 0) {
      // Add badge to bell icon
      bellIcon.innerHTML = `üîî<span style="position:absolute;top:-5px;right:-5px;background:var(--danger);color:white;border-radius:50%;width:18px;height:18px;font-size:10px;display:flex;align-items:center;justify-content:center">${unreadCount}</span>`;
    } else {
      bellIcon.innerHTML = 'üîî';
    }
  }

  // Render notifications based on current filter
  function renderNotifications() {
    notificationsList.innerHTML = '';
    
    // Filter notifications based on active filter
    let filteredNotifications = notifications;
    if (activeNotificationFilter !== 'all') {
      filteredNotifications = notifications.filter(n => n.type === activeNotificationFilter);
    }
    
    if (filteredNotifications.length === 0) {
      notificationsList.innerHTML = `
        <div class="notification-empty">
          <div class="icon">${activeNotificationFilter === 'all' ? 'üîî' : 
                          activeNotificationFilter === 'expired' ? '‚ö†Ô∏è' : 
                          activeNotificationFilter === 'soon' ? '‚è∞' : 
                          activeNotificationFilter === 'recipe' ? 'üç≥' : 
                          activeNotificationFilter === 'achievement' ? 'üèÜ' : 'üìã'}</div>
          <p>No ${activeNotificationFilter === 'all' ? '' : activeNotificationFilter} notifications</p>
          <p style="font-size:12px">${activeNotificationFilter === 'all' ? 'You\'re all caught up!' : 
                                      'Check back later for updates'}</p>
        </div>
      `;
      return;
    }
    
    filteredNotifications.forEach(notification => {
      const notificationCard = document.createElement('div');
      notificationCard.className = `notification-card ${notification.type} ${notification.unread ? 'unread' : ''}`;
      
      // Determine icon based on notification type
      let icon = 'üîî';
      let iconClass = 'notification-icon-info';
      
      switch(notification.type) {
        case 'expired':
          icon = '‚ö†Ô∏è';
          iconClass = 'notification-icon-expired';
          break;
        case 'soon':
          icon = '‚è∞';
          iconClass = 'notification-icon-soon';
          break;
        case 'recipe':
          icon = 'üç≥';
          iconClass = 'notification-icon-recipe';
          break;
        case 'achievement':
          icon = 'üèÜ';
          iconClass = 'notification-icon-achievement';
          break;
        default:
          icon = 'üìã';
          iconClass = 'notification-icon-info';
      }
      
      // Format timestamp
      const timeDiff = Math.floor((new Date() - notification.timestamp) / 1000);
      let timeAgo = '';
      
      if (timeDiff < 60) {
        timeAgo = 'Just now';
      } else if (timeDiff < 3600) {
        const minutes = Math.floor(timeDiff / 60);
        timeAgo = `${minutes}m ago`;
      } else if (timeDiff < 86400) {
        const hours = Math.floor(timeDiff / 3600);
        timeAgo = `${hours}h ago`;
      } else if (timeDiff < 604800) {
        const days = Math.floor(timeDiff / 86400);
        timeAgo = `${days}d ago`;
      } else {
        timeAgo = notification.timestamp.toLocaleDateString();
      }
      
      notificationCard.innerHTML = `
        <div class="notification-icon-small ${iconClass}">
          ${icon}
        </div>
        <div class="notification-content">
          <div class="notification-title">${notification.title}</div>
          <div class="notification-message">${notification.message}</div>
          <div class="notification-meta">
            <span class="notification-time">${timeAgo}</span>
            <div class="notification-actions">
              ${notification.unread ? '<button class="notification-action-btn dismiss" data-id="' + notification.id + '">Dismiss</button>' : ''}
              ${notification.itemId ? '<button class="notification-action-btn view" data-id="' + notification.id + '" data-type="item">View Item</button>' : 
                notification.recipeId ? '<button class="notification-action-btn view" data-id="' + notification.id + '" data-type="recipe">View Recipe</button>' :
                notification.achievementId ? '<button class="notification-action-btn view" data-id="' + notification.id + '" data-type="achievement">View Achievement</button>' : ''}
            </div>
          </div>
        </div>
      `;
      
      notificationsList.appendChild(notificationCard);
    });
    
    // Add event listeners to notification buttons
    document.querySelectorAll('.notification-action-btn.dismiss').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const notificationId = e.target.dataset.id;
        markNotificationAsRead(notificationId);
      });
    });
    
    document.querySelectorAll('.notification-action-btn.view').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const notificationId = e.target.dataset.id;
        const type = e.target.dataset.type;
        handleNotificationAction(notificationId, type);
      });
    });
  }

  // Mark notification as read
  function markNotificationAsRead(notificationId) {
    const notificationIndex = notifications.findIndex(n => n.id === notificationId);
    if (notificationIndex !== -1) {
      notifications[notificationIndex].unread = false;
      renderNotifications();
      updateNotificationBadge();
    }
  }

  // Handle notification action (view item, recipe, or achievement)
  function handleNotificationAction(notificationId, type) {
    const notification = notifications.find(n => n.id === notificationId);
    if (!notification) return;
    
    markNotificationAsRead(notificationId);
    
    switch(type) {
      case 'item':
        if (notification.itemId) {
          // Find the item and show relevant view
          const item = userItems.find(i => i.id === notification.itemId);
          if (item) {
            showView('storage');
            // Highlight or filter to show this item
            // For now, just show storage view
          }
        }
        break;
        
      case 'recipe':
        if (notification.recipeId) {
          const recipe = recipes.find(r => r.id === notification.recipeId);
          if (recipe) {
            showView('recipe');
            showRecipeDetail(recipe);
          }
        }
        break;
        
      case 'achievement':
        showView('reward');
        // Scroll to the achievement if possible
        break;
    }
  }

  // Load user achievements and stats
  async function loadUserAchievements() {
    if (!currentUser) return;
    
    try {
      const userRef = doc(db, 'users', currentUser.uid);
      const userDoc = await getDoc(userRef);
      
      if (userDoc.exists()) {
        userStats = userDoc.data().stats || {
          total_xp: 0,
          items_added: 0,
          items_used: 0,
          recipes_cooked: 0,
          recipes_viewed: 0,
          expiring_recipes: 0,
          login_streak: 0,
          add_streak: 0,
          no_expired_streak: 0,
          recipes_one_day: 0,
          unique_foods: new Set(),
          money_saved: 0,
          last_login: new Date().toISOString().split('T')[0],
          last_add_date: null
        };
        
        userAchievements = userDoc.data().achievements || {};
      } else {
        // Initialize new user
        userStats = {
          total_xp: 0,
          items_added: 0,
          items_used: 0,
          recipes_cooked: 0,
          recipes_viewed: 0,
          expiring_recipes: 0,
          login_streak: 1,
          add_streak: 0,
          no_expired_streak: 0,
          recipes_one_day: 0,
          unique_foods: new Set(),
          money_saved: 0,
          last_login: new Date().toISOString().split('T')[0],
          last_add_date: null
        };
        
        userAchievements = {};
        
        // Save initial user document
        await setDoc(userRef, {
          stats: userStats,
          achievements: userAchievements,
          createdAt: serverTimestamp()
        });
      }
      
      updateAchievementsProgress();
      renderAchievements();
      updateRewardsStats();
      updateRecentAchievements();
      updateLevelDisplay();
      
    } catch (error) {
      console.error('Error loading user achievements:', error);
    }
  }

  // Update achievement progress based on user stats
  function updateAchievementsProgress() {
    achievements = ACHIEVEMENTS.map(achievement => {
      const progress = calculateAchievementProgress(achievement);
      const unlocked = userAchievements[achievement.id] || false;
      
      return {
        ...achievement,
        progress,
        unlocked
      };
    });
  }

  // Calculate progress for an achievement
  function calculateAchievementProgress(achievement) {
    switch(achievement.progressType) {
      case 'items_added':
        return userStats.items_added || 0;
      case 'items_used':
        return userStats.items_used || 0;
      case 'recipes_cooked':
        return userStats.recipes_cooked || 0;
      case 'recipes_viewed':
        return userStats.recipes_viewed || 0;
      case 'expiring_recipes':
        return userStats.expiring_recipes || 0;
      case 'login_streak':
        return userStats.login_streak || 0;
      case 'add_streak':
        return userStats.add_streak || 0;
      case 'no_expired_streak':
        return userStats.no_expired_streak || 0;
      case 'recipes_one_day':
        return userStats.recipes_one_day || 0;
      case 'fresh_items':
        return userItems.filter(item => item.status === 'fresh').length;
      case 'storage_locations':
        const locations = new Set(userItems.map(item => item.location));
        return locations.size;
      case 'unique_foods':
        return userStats.unique_foods?.size || 0;
      case 'money_saved':
        return userStats.money_saved || 0;
      default:
        return 0;
    }
  }

  // Check and unlock achievements
  async function checkAchievements() {
    if (!currentUser) return;
    
    const userRef = doc(db, 'users', currentUser.uid);
    let newAchievements = [];
    
    for (const achievement of achievements) {
      if (!achievement.unlocked && achievement.progress >= achievement.target) {
        // Unlock achievement
        achievement.unlocked = true;
        userAchievements[achievement.id] = {
          unlockedAt: new Date().toISOString(),
          xp: achievement.xp
        };
        
        // Add XP
        userStats.total_xp = (userStats.total_xp || 0) + achievement.xp;
        
        newAchievements.push(achievement);
        
        // Update in Firestore
        await updateDoc(userRef, {
          [`achievements.${achievement.id}`]: userAchievements[achievement.id],
          'stats.total_xp': userStats.total_xp
        });
      }
    }
    
    // Show notifications for new achievements
    newAchievements.forEach(achievement => {
      showAchievementNotification(achievement);
    });
    
    if (newAchievements.length > 0) {
      renderAchievements();
      updateRewardsStats();
      updateRecentAchievements();
      updateLevelDisplay();
      generateNotifications(); // Regenerate notifications to include new achievements
      renderNotifications();
    }
  }

  // Render achievements
  function renderAchievements() {
    // Clear containers
    inventoryAchievementsEl.innerHTML = '';
    cookingAchievementsEl.innerHTML = '';
    streakAchievementsEl.innerHTML = '';
    specialAchievementsEl.innerHTML = '';
    
    // Filter achievements by category
    const inventoryAchievements = achievements.filter(a => a.category === 'inventory');
    const cookingAchievements = achievements.filter(a => a.category === 'cooking');
    const streakAchievements = achievements.filter(a => a.category === 'streak');
    const specialAchievements = achievements.filter(a => a.category === 'special');
    
    // Render each category
    renderAchievementList(inventoryAchievements, inventoryAchievementsEl);
    renderAchievementList(cookingAchievements, cookingAchievementsEl);
    renderAchievementList(streakAchievements, streakAchievementsEl);
    renderAchievementList(specialAchievements, specialAchievementsEl);
  }
  
  function renderAchievementList(achievementList, container) {
    if (achievementList.length === 0) {
      container.innerHTML = `
        <div class="empty-state" style="padding:20px;">
          <div class="icon">üèÜ</div>
          <p>No achievements in this category yet</p>
        </div>
      `;
      return;
    }
    
    achievementList.forEach(achievement => {
      const progressPercent = Math.min((achievement.progress / achievement.target) * 100, 100);
      const progressText = `${achievement.progress}/${achievement.target}`;
      const tierLabel = achievement.tier === 'gold' ? 'üèÖ' : achievement.tier === 'silver' ? 'ü•à' : 'ü•â';
      
      const card = document.createElement('div');
      card.className = `achievement-card ${achievement.unlocked ? 'unlocked' : 'locked'}`;
      
      card.innerHTML = `
        <div class="achievement-icon achievement-${achievement.tier}">
          ${achievement.icon}
          <div class="tier-indicator tier-${achievement.tier}">${tierLabel}</div>
        </div>
        <div class="achievement-info">
          <div class="achievement-name">
            ${achievement.name}
            <span class="achievement-xp">+${achievement.xp} XP</span>
          </div>
          <div class="achievement-desc">${achievement.description}</div>
          <div class="achievement-requirements">${achievement.requirements}</div>
          <div class="achievement-progress">
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progressPercent}%"></div>
            </div>
            <div class="progress-text">${progressText}</div>
          </div>
          ${achievement.unlocked && userAchievements[achievement.id]?.unlockedAt ? 
            `<div class="unlocked-date">Unlocked: ${new Date(userAchievements[achievement.id].unlockedAt).toLocaleDateString()}</div>` : 
            `<div class="achievement-status ${achievement.unlocked ? 'status-unlocked' : 'status-locked'}">
              ${achievement.unlocked ? '‚úì UNLOCKED' : 'üîí LOCKED'}
            </div>`
          }
        </div>
      `;
      
      container.appendChild(card);
    });
  }

  // Update rewards stats
  function updateRewardsStats() {
    const unlockedCount = Object.keys(userAchievements).length;
    
    totalXpEl.textContent = userStats.total_xp || 0;
    unlockedCountEl.textContent = unlockedCount;
    totalAchievementsEl.textContent = ACHIEVEMENTS.length;
  }

  // Update recent achievements in sidebar
  function updateRecentAchievements() {
    const unlockedAchievements = achievements.filter(a => a.unlocked);
    const recentAchievements = unlockedAchievements
      .sort((a, b) => {
        const dateA = new Date(userAchievements[a.id]?.unlockedAt || 0);
        const dateB = new Date(userAchievements[b.id]?.unlockedAt || 0);
        return dateB - dateA;
      })
      .slice(0, 3);
    
    recentAchievementsEl.innerHTML = '';
    
    if (recentAchievements.length === 0) {
      recentAchievementsEl.innerHTML = `
        <div class="empty-state" style="padding:20px 0;min-height:auto">
          <div class="icon">üèÜ</div>
          <p>No achievements yet</p>
          <p style="font-size:12px">Complete challenges to earn badges</p>
        </div>
      `;
      return;
    }
    
    recentAchievements.forEach(achievement => {
      const achievementDiv = document.createElement('div');
      achievementDiv.className = 'recipe';
      
      const tierColor = achievement.tier === 'gold' ? '#ffd700' : 
                       achievement.tier === 'silver' ? '#c0c0c0' : '#cd7f32';
      
      achievementDiv.innerHTML = `
        <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg, ${tierColor}, 
          ${achievement.tier === 'gold' ? '#ffed4e' : achievement.tier === 'silver' ? '#e0e0e0' : '#e6b85c'}); 
          display:flex;align-items:center;justify-content:center;font-size:18px">
          ${achievement.icon}
        </div>
        <div style="flex:1">
          <div style="font-weight:600;font-size:13px">${achievement.name}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px">${achievement.description.substring(0, 40)}...</div>
          <div style="font-size:11px;color:${tierColor};font-weight:600;margin-top:2px">+${achievement.xp} XP</div>
        </div>
      `;
      
      recentAchievementsEl.appendChild(achievementDiv);
    });
  }

  // Update user stats when actions occur
  async function updateUserStats(updates) {
    if (!currentUser) return;
    
    try {
      const userRef = doc(db, 'users', currentUser.uid);
      const statsUpdates = {};
      
      // Convert Set to Array for Firestore
      if (updates.unique_foods && updates.unique_foods instanceof Set) {
        updates.unique_foods = Array.from(updates.unique_foods);
      }
      
      Object.keys(updates).forEach(key => {
        statsUpdates[`stats.${key}`] = updates[key];
      });
      
      await updateDoc(userRef, statsUpdates);
      
      // Update local stats
      Object.keys(updates).forEach(key => {
        if (key === 'unique_foods' && Array.isArray(updates[key])) {
          userStats[key] = new Set(updates[key]);
        } else {
          userStats[key] = updates[key];
        }
      });
      
      updateAchievementsProgress();
      await checkAchievements();
      updateRewardsStats();
      updateRecentAchievements();
      updateLevelDisplay();
      
    } catch (error) {
      console.error('Error updating user stats:', error);
    }
  }

  // Check login streak
  async function checkLoginStreak() {
    if (!currentUser) return;
    
    const today = new Date().toISOString().split('T')[0];
    const lastLogin = userStats.last_login;
    
    if (lastLogin === today) {
      return; // Already logged in today
    }
    
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = yesterday.toISOString().split('T')[0];
    
    let newStreak = 1;
    if (lastLogin === yesterdayStr) {
      newStreak = (userStats.login_streak || 0) + 1;
    }
    
    await updateUserStats({
      login_streak: newStreak,
      last_login: today
    });
  }

  // Check add streak
  async function checkAddStreak(itemName) {
    const today = new Date().toISOString().split('T')[0];
    const lastAddDate = userStats.last_add_date;
    
    let newStreak = 1;
    if (lastAddDate === today) {
      newStreak = userStats.add_streak || 1;
    } else if (lastAddDate) {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = yesterday.toISOString().split('T')[0];
      
      if (lastAddDate === yesterdayStr) {
        newStreak = (userStats.add_streak || 0) + 1;
      }
    }
    
    // Update unique foods
    const uniqueFoods = userStats.unique_foods || new Set();
    uniqueFoods.add(itemName.toLowerCase());
    
    await updateUserStats({
      items_added: (userStats.items_added || 0) + 1,
      add_streak: newStreak,
      last_add_date: today,
      unique_foods: uniqueFoods
    });
  }

  // Update hero message based on items
  function updateHeroMessage() {
    if (userItems.length === 0) {
      heroTitle.textContent = "Welcome to ExpireMe!";
      heroSubtitle.textContent = "Add your first item to start tracking expiry dates";
      return;
    }

    const totalItems = userItems.length;
    const expired = userItems.filter(item => item.status === 'expired').length;
    const soon = userItems.filter(item => item.status === 'soon').length;
    const fresh = userItems.filter(item => item.status === 'fresh').length;

    // Calculate days until next expiry
    const upcomingItems = userItems.filter(item => item.days >= 0);
    let nextExpiryDays = null;
    if (upcomingItems.length > 0) {
      nextExpiryDays = Math.min(...upcomingItems.map(item => item.days));
    }

    // Generate dynamic messages
    if (expired > 0) {
      heroTitle.textContent = `‚ö†Ô∏è You have ${expired} expired item${expired > 1 ? 's' : ''}!`;
      heroSubtitle.textContent = "Check your expired items list and consider disposal";
    } else if (soon > 0) {
      heroTitle.textContent = `‚è∞ ${soon} item${soon > 1 ? 's' : ''} expiring soon`;
      heroSubtitle.textContent = `Use them within ${Math.min(...userItems.filter(i => i.status === 'soon').map(i => i.days))} days`;
    } else if (fresh > 0) {
      if (nextExpiryDays !== null) {
        heroTitle.textContent = `‚úÖ All ${fresh} items are fresh!`;
        if (nextExpiryDays === 0) {
          heroSubtitle.textContent = "1 item expires today - use it now!";
        } else if (nextExpiryDays <= 3) {
          heroSubtitle.textContent = `Next expiry in ${nextExpiryDays} day${nextExpiryDays !== 1 ? 's' : ''}`;
        } else {
          heroSubtitle.textContent = `Next expiry in ${nextExpiryDays} days - you're doing great!`;
        }
      } else {
        heroTitle.textContent = `üçé ${fresh} fresh items in your pantry`;
        heroSubtitle.textContent = "All items are fresh and ready to use";
      }
    }
  }

  // Update suggestions sidebar
  function updateSuggestions() {
    console.log('Updating suggestions...');
    suggestionsList.innerHTML = '';
    
    if (userItems.length === 0) {
      suggestionsList.innerHTML = `
        <div class="empty-state" style="padding:20px 0;min-height:auto">
          <div class="icon">üì¶</div>
          <p>No items in your pantry</p>
          <p style="font-size:12px">Add items to get recipe suggestions</p>
        </div>
      `;
      suggestionsSubtitle.textContent = "Add items to get personalized recipe suggestions";
      return;
    }
    
    const availableRecipes = recipes.filter(recipe => {
      const availability = checkRecipeAvailability(recipe);
      return availability.canMake;
    });
    
    availableRecipes.sort((a, b) => {
      const aExpiring = countExpiringSoonIngredients(a);
      const bExpiring = countExpiringSoonIngredients(b);
      return bExpiring - aExpiring;
    });
    
    const topRecipes = availableRecipes.slice(0, 3);
    
    if (topRecipes.length === 0) {
      suggestionsList.innerHTML = `
        <div class="empty-state" style="padding:20px 0;min-height:auto">
          <div class="icon">üç≥</div>
          <p>No recipes available yet</p>
          <p style="font-size:12px">Add more ingredients to unlock recipes</p>
        </div>
      `;
      suggestionsSubtitle.textContent = "Add more ingredients to unlock recipe suggestions";
      return;
    }
    
    const expiringSoonCount = userItems.filter(item => item.status === 'soon').length;
    if (expiringSoonCount > 0) {
      suggestionsSubtitle.textContent = `Make these with your ${expiringSoonCount} expiring item${expiringSoonCount > 1 ? 's' : ''}`;
    } else {
      suggestionsSubtitle.textContent = "Recipes you can make right now";
    }
    
    topRecipes.forEach(recipe => {
      const recipeDiv = document.createElement('div');
      recipeDiv.className = 'recipe';
      recipeDiv.dataset.id = recipe.id;
      
      const expiringIngredients = countExpiringSoonIngredients(recipe);
      
      recipeDiv.innerHTML = `
        <img class="rimg" src="" alt="${recipe.name}" loading="lazy">
        <div style="flex:1">
          <div style="font-weight:600;font-size:14px">${recipe.name}</div>
          <div style="font-size:12px;color:var(--muted);margin-top:2px">${recipe.prepTime} ‚Ä¢ ${recipe.servings} servings</div>
          ${expiringIngredients > 0 ? 
            `<div style="font-size:11px;color:#ff8c00;margin-top:4px">Uses ${expiringIngredients} expiring ingredient${expiringIngredients > 1 ? 's' : ''}</div>` : 
            `<div style="font-size:11px;color:var(--success);margin-top:4px">All ingredients fresh</div>`
          }
        </div>
      `;
      
      const imgElement = recipeDiv.querySelector('.rimg');
      if (recipe.image && recipe.image.trim() !== '') {
        handleImageLoad(imgElement, recipe.image);
      } else {
        imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA2NCA0OCIgZmlsbD0iI2YwZjRmNSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48L3N2Zz4=';
      }
      
      recipeDiv.addEventListener('click', () => {
        showRecipeDetail(recipe);
        showView('recipe');
      });
      
      suggestionsList.appendChild(recipeDiv);
    });
  }
  
  function countExpiringSoonIngredients(recipe) {
    let count = 0;
    
    if (!recipe.ingredients || !Array.isArray(recipe.ingredients)) {
      return 0;
    }
    
    recipe.ingredients.forEach(ingredient => {
      const matchingItems = userItems.filter(item => 
        item.name.toLowerCase().includes(ingredient.name.toLowerCase()) ||
        ingredient.name.toLowerCase().includes(item.name.toLowerCase())
      );
      
      const hasExpiringSoon = matchingItems.some(item => item.status === 'soon');
      if (hasExpiringSoon) {
        count++;
      }
    });
    
    return count;
  }

  // Handle image loading
  function handleImageLoad(imgElement, imageUrl) {
    const whiteImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9IiNmZmZmZmYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PC9zdmc+';
    
    if (!imageUrl || imageUrl.trim() === '') {
      imgElement.src = whiteImage;
      return;
    }
    
    let processedUrl = imageUrl;
    
    if (imageUrl.includes('drive.google.com/file/d/')) {
      const fileIdMatch = imageUrl.match(/\/d\/([^\/]+)/);
      if (fileIdMatch && fileIdMatch[1]) {
        processedUrl = `https://drive.google.com/uc?id=${fileIdMatch[1]}&export=download`;
      }
    } else if (imageUrl.includes('drive.google.com/open?id=')) {
      const fileIdMatch = imageUrl.match(/id=([^&]+)/);
      if (fileIdMatch && fileIdMatch[1]) {
        processedUrl = `https://drive.google.com/uc?id=${fileIdMatch[1]}&export=download`;
      }
    } else if (imageUrl.includes('drive.google.com/uc?export=view&id=')) {
      processedUrl = imageUrl.replace('export=view', 'export=download');
    }
    
    imgElement.onerror = function() {
      console.warn(`Failed to load image from: ${processedUrl}`);
      
      const fileIdMatch = processedUrl.match(/id=([^&]+)/);
      if (fileIdMatch && fileIdMatch[1]) {
        const altUrl = `https://lh3.googleusercontent.com/d/${fileIdMatch[1]}`;
        
        this.src = altUrl;
        
        this.onerror = function() {
          this.src = whiteImage;
          this.onerror = null;
        };
      } else {
        this.src = whiteImage;
        this.onerror = null;
      }
    };
    
    imgElement.src = processedUrl;
  }

  // Auth Check
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = 'login.html';
    } else {
      currentUser = user;
      console.log('User logged in:', user.uid, user.displayName || user.email);
      
      updateUserInterface(user);
      initializeDefaultRecipes();
      loadUserItems();
      loadRecipes();
      loadUserAchievements();
      checkLoginStreak();
    }
  });

  // Update user interface with user data
  function updateUserInterface(user) {
    if (user.displayName) {
      userGreeting.textContent = `Hi ${user.displayName}`;
      userAvatar.textContent = user.displayName.charAt(0).toUpperCase();
    } else if (user.email) {
      const userName = user.email.split('@')[0];
      userGreeting.textContent = `Hi ${userName}`;
      userAvatar.textContent = userName.charAt(0).toUpperCase();
    }
  }

  // Load user items from Firestore
  function loadUserItems() {
    try {
      console.log('Loading items for user:', currentUser.uid);
      const itemsRef = collection(db, 'items');
      const q = query(
        itemsRef, 
        where('userId', '==', currentUser.uid),
        orderBy('expiryDate', 'asc')
      );
      
      unsubscribeItems = onSnapshot(q, 
        (snapshot) => {
          console.log('Snapshot received, docs count:', snapshot.size);
          userItems = [];
          
          if (snapshot.empty) {
            console.log('No items found for user');
            showEmptyState();
            updateRecipesAvailability();
            updateSuggestions();
            return;
          }
          
          snapshot.forEach((doc) => {
            const data = doc.data();
            
            let expiryDate;
            if (data.expiryDate && data.expiryDate.toDate) {
              expiryDate = data.expiryDate.toDate();
            } else if (data.expiryDate instanceof Date) {
              expiryDate = data.expiryDate;
            } else {
              console.warn('Invalid expiry date format:', data.expiryDate);
              return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const timeDiff = expiryDate.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            let status = 'fresh';
            if (daysDiff < 0) status = 'expired';
            else if (daysDiff <= 7) status = 'soon';
            
            const item = {
              id: doc.id,
              name: data.name || 'Unknown',
              quantity: data.quantity || 1,
              unit: data.unit || 'pieces',
              location: data.location || 'pantry',
              expiryDate: expiryDate,
              days: daysDiff,
              status: status
            };
            
            userItems.push(item);
          });
          
          updateStats();
          renderHome('expired');
          renderStorage();
          updateHeroMessage();
          updateRecipesAvailability();
          updateSuggestions();
          updateAchievementsProgress();
          checkAchievements();
          generateNotifications(); // Generate notifications when items are loaded
          renderNotifications();
          
        }, 
        (error) => {
          console.error('Error in onSnapshot:', error);
          showEmptyState();
          
          listEl.innerHTML = `
            <div class="empty-state">
              <div class="icon">‚ùå</div>
              <p>Error loading items</p>
              <p>Please check console for details</p>
            </div>
          `;
        }
      );
    } catch (error) {
      console.error('Error loading items:', error);
      showEmptyState();
    }
  }

  // Load recipes from Firestore
  function loadRecipes() {
    try {
      const recipesRef = collection(db, 'recipes');
      const q = query(recipesRef, orderBy('name'));
      
      unsubscribeRecipes = onSnapshot(q, 
        (snapshot) => {
          console.log('Recipes snapshot received, docs count:', snapshot.size);
          recipes = [];
          
          if (snapshot.empty) {
            console.log('No recipes found in Firestore');
            recipeGridEl.innerHTML = `
              <div class="empty-state">
                <div class="icon">üìö</div>
                <p>No recipes available</p>
                <p>Add recipes to the database to get started!</p>
            </div>
            `;
            return;
          }
          
          snapshot.forEach((doc) => {
            const data = doc.data();
            const recipe = {
              id: doc.id,
              name: data.name || 'Unnamed Recipe',
              image: data.image || '',
              description: data.description || '',
              prepTime: data.prepTime || 'N/A',
              cookTime: data.cookTime || 'N/A',
              difficulty: data.difficulty || 'N/A',
              servings: data.servings || 1,
              ingredients: data.ingredients || [],
              instructions: data.instructions || [],
              totalCost: data.totalCost || 0
            };
            recipes.push(recipe);
          });
          
          console.log('Loaded recipes from Firestore:', recipes.length);
          updateRecipesAvailability();
          updateSuggestions();
          generateNotifications(); // Regenerate notifications when recipes are loaded
          renderNotifications();
          
        }, 
        (error) => {
          console.error('Error loading recipes:', error);
          recipeGridEl.innerHTML = `
            <div class="empty-state">
              <div class="icon">‚ùå</div>
              <p>Error loading recipes</p>
              <p>Please check console for details</p>
            </div>
          `;
        }
      );
    } catch (error) {
      console.error('Error loading recipes:', error);
    }
  }

  // Check if user has enough ingredients for a recipe
  function checkRecipeAvailability(recipe) {
    const availability = {
      canMake: true,
      missingIngredients: [],
      availableIngredients: [],
      availableCost: 0
    };
    
    if (!recipe.ingredients || recipe.ingredients.length === 0) {
      availability.canMake = false;
      return availability;
    }
    
    recipe.ingredients.forEach(ingredient => {
      const matchingItems = userItems.filter(item => 
        item.name.toLowerCase().includes(ingredient.name.toLowerCase()) ||
        ingredient.name.toLowerCase().includes(item.name.toLowerCase())
      );
      
      if (matchingItems.length > 0) {
        const totalQuantity = matchingItems.reduce((sum, item) => sum + item.quantity, 0);
        
        if (totalQuantity >= ingredient.quantity) {
          availability.availableIngredients.push({
            ingredient,
            available: totalQuantity,
            items: matchingItems
          });
          availability.availableCost += (ingredient.cost || 0);
        } else {
          availability.canMake = false;
          availability.missingIngredients.push({
            ingredient,
            available: totalQuantity,
            needed: ingredient.quantity
          });
        }
      } else {
        availability.canMake = false;
        availability.missingIngredients.push({
          ingredient,
          available: 0,
          needed: ingredient.quantity
        });
      }
    });
    
    return availability;
  }

  // Update recipes based on available ingredients
  function updateRecipesAvailability() {
    console.log('Updating recipes based on user items:', userItems.length);
    
    if (recipes.length === 0) {
      recipeGridEl.innerHTML = `
        <div class="empty-state">
          <div class="icon">üìö</div>
          <p>No recipes available</p>
          <p>Add recipes to the database to get started!</p>
        </div>
      `;
      return;
    }
    
    const updatedRecipes = recipes.map(recipe => {
      const availability = checkRecipeAvailability(recipe);
      return {
        ...recipe,
        availability
      };
    });
    
    recipes = updatedRecipes;
    renderRecipes();
  }

  // Render recipe list
  function renderRecipes() {
    console.log('Rendering recipes:', recipes.length);
    recipeGridEl.innerHTML = '';
    
    if (recipes.length === 0) {
      recipeGridEl.innerHTML = `
        <div class="empty-state">
          <div class="icon">üìö</div>
          <p>No recipes available</p>
          <p>Check back later for recipe suggestions!</p>
        </div>
      `;
      return;
    }
    
    // Update recipes viewed stat
    updateUserStats({
      recipes_viewed: (userStats.recipes_viewed || 0) + 1
    });
    
    recipes.forEach(recipe => {
      const canMake = recipe.availability ? recipe.availability.canMake : false;
      const availableCount = recipe.availability ? recipe.availability.availableIngredients.length : 0;
      const totalCount = recipe.ingredients ? recipe.ingredients.length : 0;
      
      const recipeCard = document.createElement('div');
      recipeCard.className = 'recipe-card';
      recipeCard.dataset.id = recipe.id;
      
      recipeCard.innerHTML = `
        <img class="img" src="" alt="${recipe.name}" loading="lazy">
        <div class="info">
          <div class="title">${recipe.name}</div>
          <div class="time">‚è±Ô∏è ${recipe.prepTime} ‚Ä¢ üë• ${recipe.servings} servings</div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-size:12px;color:${canMake ? 'var(--success)' : 'var(--danger)'};font-weight:600">
                ${canMake ? '‚úÖ Can Make' : '‚ùå Missing Ingredients'}
              </div>
              <div style="font-size:11px;color:var(--muted)">
                ${availableCount}/${totalCount} ingredients available
              </div>
            </div>
            <div style="font-size:18px;cursor:pointer" class="heart">${canMake ? '‚ù§Ô∏è' : 'ü§ç'}</div>
          </div>
        </div>
      `;
      
      const imgElement = recipeCard.querySelector('.img');
      if (recipe.image && recipe.image.trim() !== '') {
        handleImageLoad(imgElement, recipe.image);
      } else {
        imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9IiNmZmZmZmYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PC9zdmc+';
      }
      
      recipeCard.addEventListener('click', () => {
        showRecipeDetail(recipe);
      });
      
      recipeGridEl.appendChild(recipeCard);
    });
  }

  // Show recipe detail view
  function showRecipeDetail(recipe) {
    currentRecipeDetail = recipe;
    recipeListView.style.display = 'none';
    recipeDetailView.style.display = 'block';
    
    const availability = recipe.availability || { canMake: false, availableIngredients: [] };
    const canMake = availability.canMake;
    
    let ingredientsHTML = '';
    if (recipe.ingredients && recipe.ingredients.length > 0) {
      recipe.ingredients.forEach((ingredient, index) => {
        const matchingItems = userItems.filter(item => 
          item.name.toLowerCase().includes(ingredient.name.toLowerCase()) ||
          ingredient.name.toLowerCase().includes(item.name.toLowerCase())
        );
        const totalAvailable = matchingItems.reduce((sum, item) => sum + item.quantity, 0);
        const hasEnough = totalAvailable >= ingredient.quantity;
        
        ingredientsHTML += `
          <div class="ingredient-item">
            <div class="ingredient-check ${hasEnough ? 'available' : 'unavailable'}">
              ${hasEnough ? '‚úì' : '‚úó'}
            </div>
            <div class="ingredient-details">
              <div class="ingredient-name">${ingredient.name.charAt(0).toUpperCase() + ingredient.name.slice(1)}</div>
              <div class="ingredient-quantity">${ingredient.quantity} ${ingredient.unit} ($${(ingredient.cost || 0).toFixed(2)})</div>
            </div>
            <div class="ingredient-status ${hasEnough ? 'available' : 'unavailable'}">
              ${hasEnough ? `Available: ${totalAvailable} ${ingredient.unit}` : `Need: ${ingredient.quantity - totalAvailable} more`}
            </div>
          </div>
        `;
      });
    } else {
      ingredientsHTML = `<p style="color:var(--muted);text-align:center">No ingredients listed for this recipe.</p>`;
    }
    
    let instructionsHTML = '';
    if (recipe.instructions && recipe.instructions.length > 0) {
      recipe.instructions.forEach((instruction, index) => {
        instructionsHTML += `
          <div class="instruction-step">
            <div class="instruction-number">${index + 1}</div>
            <div>${instruction}</div>
          </div>
        `;
      });
    } else {
      instructionsHTML = `<p style="color:var(--muted);text-align:center">No instructions available for this recipe.</p>`;
    }
    
    recipeDetailContent.innerHTML = `
      <img class="recipe-detail-image" src="" alt="${recipe.name}" loading="lazy">
      <h2 class="recipe-detail-title">${recipe.name}</h2>
      <div class="recipe-detail-meta">
        <span>‚è±Ô∏è ${recipe.prepTime || 'N/A'} prep</span>
        <span>üî• ${recipe.cookTime || 'N/A'} cook</span>
        <span>üìä ${recipe.difficulty || 'N/A'}</span>
        <span>üë• ${recipe.servings || 'N/A'} servings</span>
      </div>
      <p style="color:var(--muted);margin-bottom:20px">${recipe.description || 'No description available.'}</p>
      
      <div class="recipe-section">
        <h3 class="recipe-section-title">Ingredients</h3>
        <div class="ingredients-list">
          ${ingredientsHTML}
        </div>
      </div>
      
      <div class="recipe-section">
        <h3 class="recipe-section-title">Instructions</h3>
        <div class="instructions-list">
          ${instructionsHTML}
        </div>
      </div>
      
      <div class="recipe-cost">
        <h3 class="recipe-section-title">Cost Breakdown</h3>
        ${recipe.ingredients ? recipe.ingredients.map(ing => `
          <div class="cost-row">
            <span>${ing.name.charAt(0).toUpperCase() + ing.name.slice(1)}</span>
            <span>$${(ing.cost || 0).toFixed(2)}</span>
          </div>
        `).join('') : '<p style="color:var(--muted);text-align:center">No cost information available.</p>'}
        <div class="cost-row cost-total">
          <span>Total Estimated Cost</span>
          <span>$${recipe.totalCost ? recipe.totalCost.toFixed(2) : '0.00'}</span>
        </div>
      </div>
      
      <button class="cook-button" id="cookRecipeBtn" ${canMake ? '' : 'disabled'}>
        ${canMake ? 'üç≥ Cook This Recipe' : '‚ùå Missing Ingredients'}
      </button>
      <div id="cookMessage" style="margin-top:12px;text-align:center;font-size:13px;min-height:20px"></div>
    `;
    
    const detailImgElement = recipeDetailContent.querySelector('.recipe-detail-image');
    if (recipe.image && recipe.image.trim() !== '') {
      handleImageLoad(detailImgElement, recipe.image);
    } else {
      detailImgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9IiNmZmZmZmYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PC9zdmc+';
    }
    
    const cookBtn = document.getElementById('cookRecipeBtn');
    if (cookBtn) {
      cookBtn.addEventListener('click', () => cookRecipe(recipe));
    }
  }

  // Cook recipe - deduct ingredients from pantry
  async function cookRecipe(recipe) {
    const cookBtn = document.getElementById('cookRecipeBtn');
    const cookMessage = document.getElementById('cookMessage');
    
    cookBtn.disabled = true;
    cookBtn.textContent = 'Cooking...';
    cookMessage.textContent = '';
    cookMessage.className = '';
    
    try {
      const updates = [];
      let usedExpiringItems = false;
      
      // For each ingredient, deduct from user's items
      for (const ingredient of recipe.ingredients) {
        let remainingNeeded = ingredient.quantity;
        
        // Find all matching items
        const matchingItems = userItems.filter(item => 
          item.name.toLowerCase().includes(ingredient.name.toLowerCase()) ||
          ingredient.name.toLowerCase().includes(item.name.toLowerCase())
        );
        
        // Sort by expiry date (use freshest first)
        matchingItems.sort((a, b) => a.days - b.days);
        
        for (const item of matchingItems) {
          if (remainingNeeded <= 0) break;
          
          // Check if item is expiring soon
          if (item.status === 'soon') {
            usedExpiringItems = true;
          }
          
          const itemRef = doc(db, 'items', item.id);
          
          if (item.quantity > remainingNeeded) {
            // Deduct partial quantity
            const newQuantity = item.quantity - remainingNeeded;
            updates.push(updateDoc(itemRef, { quantity: newQuantity }));
            remainingNeeded = 0;
          } else {
            // Use entire item
            updates.push(deleteDoc(itemRef));
            remainingNeeded -= item.quantity;
          }
        }
      }
      
      // Execute all updates
      await Promise.all(updates);
      
      // Update user stats
      const updatesStats = {
        recipes_cooked: (userStats.recipes_cooked || 0) + 1,
        items_used: (userStats.items_used || 0) + updates.length,
        money_saved: (userStats.money_saved || 0) + (recipe.totalCost || 0)
      };
      
      if (usedExpiringItems) {
        updatesStats.expiring_recipes = (userStats.expiring_recipes || 0) + 1;
      }
      
      await updateUserStats(updatesStats);
      
      cookMessage.textContent = '‚úÖ Recipe cooked successfully! Ingredients deducted from your pantry.';
      cookMessage.style.color = 'var(--success)';
      cookBtn.textContent = 'üç≥ Cooked!';
      
      setTimeout(() => {
        cookMessage.textContent = '';
        cookBtn.disabled = false;
        cookBtn.textContent = 'üç≥ Cook This Recipe';
        
        recipeDetailView.style.display = 'none';
        recipeListView.style.display = 'block';
      }, 2000);
      
      // Regenerate notifications after cooking
      generateNotifications();
      renderNotifications();
      
    } catch (error) {
      console.error('Error cooking recipe:', error);
      cookMessage.textContent = '‚ùå Error cooking recipe. Please try again.';
      cookMessage.style.color = 'var(--danger)';
      cookBtn.disabled = false;
      cookBtn.textContent = 'üç≥ Cook This Recipe';
    }
  }

  // Show empty state
  function showEmptyState() {
    listEl.innerHTML = `
      <div class="empty-state">
        <div class="icon">üì¶</div>
        <p>No items yet</p>
        <p>Add your first item to get started!</p>
      </div>
    `;
    
    storageListEl.innerHTML = `
      <div class="empty-state">
        <div class="icon">üì¶</div>
        <p>No items in this storage</p>
        <p>Add items to see them here</p>
      </div>
    `;
    
    expiredCountEl.textContent = '0';
    soonCountEl.textContent = '0';
    freshCountEl.textContent = '0';
    summaryExpiredEl.textContent = '0';
    summarySoonEl.textContent = '0';
    summaryFreshEl.textContent = '0';
  }

  // Update stats based on user items
  function updateStats() {
    const expiredCount = userItems.filter(item => item.status === 'expired').length;
    const soonCount = userItems.filter(item => item.status === 'soon').length;
    const freshCount = userItems.filter(item => item.status === 'fresh').length;
    
    expiredCountEl.textContent = expiredCount;
    soonCountEl.textContent = soonCount;
    freshCountEl.textContent = freshCount;
    
    summaryExpiredEl.textContent = expiredCount;
    summarySoonEl.textContent = soonCount;
    summaryFreshEl.textContent = freshCount;
  }

  // Render Functions
  function renderHome(filter='expired') {
    listEl.innerHTML = '';
    const filtered = userItems.filter(i => filter === 'all' ? true : i.status === filter);
    
    if (!filtered.length) {
      const message = filter === 'expired' ? 'expired items' : 
                     filter === 'soon' ? 'items expiring soon' : 
                     'fresh items';
      listEl.innerHTML = `
        <div class="empty-state">
          <div class="icon">‚úÖ</div>
          <p>No ${message}</p>
          <p>All your items are ${filter === 'expired' ? 'fresh or expiring soon' : 
                                filter === 'soon' ? 'fresh or expired' : 
                                'expired or expiring soon'}!</p>
        </div>
      `;
      return;
    }
    
    filtered.forEach(it => {
      const badgeClass = it.status === 'expired' ? 'expired' : it.status === 'soon' ? 'soon' : 'fresh';
      const badgeText = it.status === 'expired' ? 'Expired' : it.status === 'soon' ? 'Expiring Soon' : 'Fresh';
      const daysText = it.days < 0 ? `${Math.abs(it.days)} days ago` : 
                      it.days === 0 ? 'Today' : 
                      `${it.days} days`;
      
      const item = document.createElement('div');
      item.className = 'item';
      item.innerHTML = `
        <div class="img">${it.name.charAt(0).toUpperCase()}</div>
        <div class="meta">
          <div class="title">${it.name}</div>
          <div class="sub">${it.quantity} ${it.unit} ‚Ä¢ ${it.location} ‚Ä¢ ${daysText}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
          <div class="badge ${badgeClass}">${badgeText}</div>
          <div class="check" data-id="${it.id}">‚úì</div>
        </div>
      `;
      listEl.appendChild(item);
      
      const checkBtn = item.querySelector('.check');
      checkBtn.addEventListener('click', () => {
        handleItemCheck(it.id);
      });
    });
  }

  function renderStorage(location = storageActiveLoc, searchQuery = '') {
    storageListEl.innerHTML = '';
    const filtered = userItems.filter(i => 
      i.location === location && 
      i.name.toLowerCase().includes(searchQuery.toLowerCase())
    );
    
    if (!filtered.length) {
      const locationName = location === 'fridge' ? 'fridge' : 
                         location === 'freezer' ? 'freezer' : 'pantry';
      storageListEl.innerHTML = `
        <div class="empty-state">
          <div class="icon">üì¶</div>
          <p>No items in your ${locationName}</p>
          <p>Add items to see them here</p>
        </div>
      `;
      return;
    }
    
    filtered.forEach(it => {
      const daysText = it.days <= 0 ? 
        `Expired ${Math.abs(it.days)} day${Math.abs(it.days) === 1 ? '' : 's'} ago` : 
        `Expires in ${it.days} day${it.days === 1 ? '' : 's'}`;
        
      const node = document.createElement('div');
      node.className = 'storage-item';
      node.innerHTML = `
        <div class="left">
          <div class="progress">${it.name.charAt(0).toUpperCase()}</div>
          <div class="meta">
            <div style="font-weight:600">${it.name}</div>
            <div class="sub">${daysText}</div>
          </div>
        </div>
        <div class="check" data-id="${it.id}">‚úì</div>
      `;
      storageListEl.appendChild(node);
      
      const checkBtn = node.querySelector('.check');
      checkBtn.addEventListener('click', () => {
        handleItemCheck(it.id);
      });
    });
  }

  // Handle item check (mark as used/remove)
  async function handleItemCheck(itemId) {
    if (confirm('Mark this item as used/consumed? This will remove it from your list.')) {
      try {
        await deleteDoc(doc(db, 'items', itemId));
        
        // Update user stats
        await updateUserStats({
          items_used: (userStats.items_used || 0) + 1
        });
        
        console.log('Item removed:', itemId);
        
        // Regenerate notifications after item removal
        generateNotifications();
        renderNotifications();
        
      } catch (error) {
        console.error('Error removing item:', error);
        alert('Error removing item. Please try again.');
      }
    }
  }

  function showView(view) {
    document.getElementById('view-home').style.display = view === 'home' ? '' : 'none';
    document.getElementById('view-storage').style.display = view === 'storage' ? '' : 'none';
    document.getElementById('view-recipe').style.display = view === 'recipe' ? '' : 'none';
    document.getElementById('view-reward').style.display = view === 'reward' ? '' : 'none';
    document.getElementById('view-notification').style.display = view === 'notification' ? '' : 'none';
    navButtons.forEach(b => b.classList.toggle('active', b.id === `nav-${view}`));
    
    if (view === 'recipe') {
      recipeListView.style.display = 'block';
      recipeDetailView.style.display = 'none';
      updateRecipesAvailability();
    } else if (view === 'storage') {
      storageSearch.focus();
      renderStorage();
    } else if (view === 'reward') {
      updateRewardsStats();
      updateRecentAchievements();
      updateLevelDisplay();
    } else if (view === 'notification') {
      // Generate fresh notifications when viewing notification page
      generateNotifications();
      renderNotifications();
    }
  }

  // Add Item Modal Functions
  function openAddItemModal() {
    addItemModal.classList.add('active');
    document.getElementById('itemName').focus();
  }

  function closeAddItemModal() {
    addItemModal.classList.remove('active');
    addItemForm.reset();
    formMessage.textContent = '';
    formMessage.className = 'form-message';
    saveItemBtn.disabled = false;
    saveItemBtn.textContent = 'Add Item';
  }

  async function saveItem(itemData) {
    try {
      console.log('Saving item:', itemData);
      const itemsRef = collection(db, 'items');
      const docRef = await addDoc(itemsRef, {
        ...itemData,
        userId: currentUser.uid,
        createdAt: serverTimestamp()
      });
      
      console.log('Item added with ID:', docRef.id);
      
      // Update user stats and check streaks
      await checkAddStreak(itemData.name);
      
      formMessage.textContent = 'Item added successfully!';
      formMessage.className = 'form-message success';
      
      setTimeout(() => {
        closeAddItemModal();
      }, 1500);
      
      // Regenerate notifications after adding item
      generateNotifications();
      renderNotifications();
      
      return true;
    } catch (error) {
      console.error('Error adding item:', error);
      
      let errorMessage = 'Error adding item. Please try again.';
      
      if (error.code === 'permission-denied') {
        errorMessage = 'Permission denied. Please check Firestore security rules.';
      } else if (error.code === 'unavailable') {
        errorMessage = 'Network error. Please check your connection.';
      }
      
      formMessage.textContent = errorMessage;
      formMessage.className = 'form-message error';
      
      saveItemBtn.disabled = false;
      saveItemBtn.textContent = 'Add Item';
      
      return false;
    }
  }

  // Initialize the application
  function initApp() {
    updateCurrentDate();
    
    // Settings dropdown functionality
    btnSettings.addEventListener('click', (e) => {
      e.stopPropagation();
      settingsDropdown.classList.toggle('show');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.settings-container')) {
        settingsDropdown.classList.remove('show');
      }
    });
    
    // Logout functionality
    btnLogout.addEventListener('click', () => {
      if (unsubscribeItems) {
        unsubscribeItems();
      }
      if (unsubscribeRecipes) {
        unsubscribeRecipes();
      }
      signOut(auth).then(() => {
        window.location.href = 'login.html';
      });
    });
    
    // Add Item Modal Event Listeners
    navAdd.addEventListener('click', openAddItemModal);
    modalClose.addEventListener('click', closeAddItemModal);
    cancelAdd.addEventListener('click', closeAddItemModal);

    addItemForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const itemName = document.getElementById('itemName').value.trim();
      const itemQuantity = parseInt(document.getElementById('itemQuantity').value);
      const itemUnit = document.getElementById('itemUnit').value;
      const itemLocation = document.getElementById('itemLocation').value;
      const itemExpiry = document.getElementById('itemExpiry').value;
      
      if (!itemName) {
        formMessage.textContent = 'Please enter an item name.';
        formMessage.className = 'form-message error';
        return;
      }
      
      if (itemQuantity <= 0) {
        formMessage.textContent = 'Please enter a valid quantity.';
        formMessage.className = 'form-message error';
        return;
      }
      
      if (!itemExpiry) {
        formMessage.textContent = 'Please select an expiry date.';
        formMessage.className = 'form-message error';
        return;
      }
      
      saveItemBtn.disabled = true;
      saveItemBtn.textContent = 'Adding...';
      formMessage.textContent = '';
      formMessage.className = 'form-message';
      
      const itemData = {
        name: itemName,
        quantity: itemQuantity,
        unit: itemUnit,
        location: itemLocation,
        expiryDate: new Date(itemExpiry)
      };
      
      await saveItem(itemData);
    });

    // Close modal when clicking outside
    addItemModal.addEventListener('click', (e) => {
      if (e.target === addItemModal) {
        closeAddItemModal();
      }
    });

    // Toast close button
    toastClose.addEventListener('click', () => {
      achievementToast.classList.remove('show');
    });

    // Recipe navigation
    recipeBack.addEventListener('click', () => showView('home'));
    recipeDetailBack.addEventListener('click', () => {
      recipeDetailView.style.display = 'none';
      recipeListView.style.display = 'block';
    });

    // Notification filter buttons
    notificationFilters.addEventListener('click', (e) => {
      if (e.target.classList.contains('notification-filter')) {
        // Remove active class from all filters
        document.querySelectorAll('.notification-filter').forEach(filter => {
          filter.classList.remove('active');
        });
        
        // Add active class to clicked filter
        e.target.classList.add('active');
        activeNotificationFilter = e.target.dataset.filter;
        
        // Re-render notifications with new filter
        renderNotifications();
      }
    });

    // Notification bell button - show notification view
    btnBell.addEventListener('click', () => {
      showView('notification');
      // Mark all notifications as read when viewing
      notifications.forEach(n => n.unread = false);
      updateNotificationBadge();
      renderNotifications();
    });

    // Existing Event Listeners
    stats.forEach(s => {
      s.addEventListener('click', () => {
        stats.forEach(x => {
          x.classList.remove('active');
          x.setAttribute('aria-selected', 'false');
        });
        s.classList.add('active');
        s.setAttribute('aria-selected', 'true');
        renderHome(s.getAttribute('data-type'));
      });
    });

    tabEls.forEach(t => {
      t.addEventListener('click', () => {
        tabEls.forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        storageActiveLoc = t.getAttribute('data-loc');
        renderStorage(storageActiveLoc, storageSearch.value);
      });
    });

    storageSearch.addEventListener('input', () => {
      renderStorage(storageActiveLoc, storageSearch.value);
    });

    navButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        if (btn.id === 'nav-home') showView('home');
        else if (btn.id === 'nav-storage') showView('storage');
        else if (btn.id === 'nav-recipe') showView('recipe');
        else if (btn.id === 'nav-reward') showView('reward');
      });
    });
  }

  // Initialize the app when DOM is loaded
  document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>