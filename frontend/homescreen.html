<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ExpireMe ‚Äî Home</title>
  <style>
    :root{
      --bg:#f6fafb; --card:#ffffff; --muted:#6b7280; --accent:#138496; --accent-2:#2b7cff;
      --danger:#d9534f; --success:#0f5132; --glass: rgba(19,128,140,0.06);
      --radius:12px; --container:1100px;
      --shadow:0 8px 20px rgba(23,43,77,0.08);
    }
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#f0f7f8 0%,var(--bg)100%);color:#21303b}
    .wrap{max-width:var(--container);margin:28px auto;padding:20px;display:flex;gap:20px;align-items:flex-start}
    .main{flex:1;display:flex;flex-direction:column;gap:18px}
    .sidebar{width:320px;display:flex;flex-direction:column;gap:18px}
    header.top{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:transparent}
    .profile{display:flex;align-items:center;gap:12px}
    .avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#ffe9c6,#ffd7a8);display:flex;align-items:center;justify-content:center;font-weight:700;color:#7a4b08}
    .greeting{font-size:18px;font-weight:600}
    .icons{display:flex;gap:12px;align-items:center}
    .icon-btn{width:36px;height:36px;border-radius:8px;display:inline-grid;place-items:center;background:var(--card);box-shadow:var(--shadow);cursor:pointer}
    .hero{background:linear-gradient(180deg,#0fa3a7 0%,#137b7c 100%);color:#fff;padding:20px;border-radius:14px;box-shadow:var(--shadow);display:flex;gap:18px;align-items:center}
    .hero .text{flex:1}
    .hero h2{margin:0 0 6px;font-size:20px}
    .hero p{margin:0;font-size:13px;opacity:0.95}
    .thumbs{display:flex;gap:10px}
    .thumb{width:86px;height:70px;border-radius:10px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .section-title{text-align:center;padding:8px 0}
    .section-title .date{font-size:12px;color:var(--muted);margin-bottom:6px}
    .section-title h3{margin:0;font-size:20px}
    .stats{display:flex;gap:12px;align-items:center;justify-content:center}
    .stat{background:var(--card);padding:12px 18px;border-radius:999px;box-shadow:var(--shadow);min-width:120px;text-align:center;cursor:pointer}
    .stat .num{font-size:20px;font-weight:700}
    .stat .label{font-size:12px;color:var(--muted)}
    .stat.active{background:linear-gradient(90deg,#e6f7f7,#f1fcfe);border:1px solid rgba(19,128,140,0.08)}
    .list{background:var(--card);padding:18px;border-radius:14px;box-shadow:var(--shadow);min-height:320px}
    .item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfeff);box-shadow:0 4px 12px rgba(16,54,63,0.04);margin-bottom:10px}
    .item:last-child{margin-bottom:0}
    .item .img{width:56px;height:56px;border-radius:10px;background:var(--glass);display:flex;align-items:center;justify-content:center;font-weight:600;color:#6b7280}
    .item .meta{flex:1}
    .item .meta .title{font-weight:600;margin-bottom:4px}
    .item .meta .sub{font-size:13px;color:var(--muted)}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px}
    .badge.expired{background:rgba(217,83,79,0.08);color:var(--danger)}
    .badge.soon{background:rgba(255,171,0,0.08);color:#ff8c00}
    .badge.fresh{background:rgba(15,81,50,0.08);color:var(--success)}
    .check{width:36px;height:36px;border-radius:50%;border:2px solid #e6eef0;display:grid;place-items:center;color:var(--accent-2)}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow)}
    .small-title{font-size:13px;color:var(--muted);margin-bottom:8px}
    .recipe-grid{display:flex;flex-direction:column;gap:8px}
    .recipe{display:flex;gap:10px;align-items:center}
    .recipe .rimg{width:64px;height:48px;border-radius:8px;background:#f0f4f5;display:block;object-fit:cover}
    .search{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--card);border-radius:999px;box-shadow:var(--shadow);margin:12px 0}
    .search input{border:0;outline:0;width:100%;font-size:14px;background:transparent}
    .tabs{display:flex;gap:12px;padding:8px}
    .tab{padding:8px 12px;border-radius:999px;cursor:pointer;color:var(--muted);background:transparent}
    .tab.active{background:linear-gradient(90deg,#e6f7f7,#f1fcfe);color:var(--accent-2);font-weight:600;box-shadow:var(--shadow)}
    .storage-list{background:linear-gradient(180deg,#eaf9f9,#ffffff);padding:14px;border-radius:14px}
    .storage-item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;background:var(--card);border-radius:10px;margin-bottom:10px;box-shadow:0 6px 14px rgba(16,54,63,0.03)}
    .storage-item .left{display:flex;gap:12px;align-items:center}
    .progress{width:44px;height:44px;border-radius:50%;background:linear-gradient(180deg,#fff,#fbfeff);display:grid;place-items:center;border:6px solid rgba(255,171,0,0.08)}
    .storage-item .meta .sub{font-weight:700;color:#111}
    .recipe-grid-page{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px;padding:12px 0}
    .recipe-card{background:var(--card);border-radius:14px;overflow:hidden;box-shadow:var(--shadow);cursor:pointer;transition:transform 0.2s}
    .recipe-card:hover{transform:translateY(-4px)}
    .recipe-card .img{width:100%;height:140px;object-fit:cover;display:block}
    .recipe-card .info{padding:10px}
    .recipe-card .title{font-weight:600;font-size:14px;margin-bottom:6px}
    .recipe-card .time{display:flex;align-items:center;gap:4px;font-size:12px;color:var(--muted);margin-bottom:8px}
    .recipe-card .heart{cursor:pointer;font-size:18px}
    .recipe-back{display:flex;align-items:center;gap:8px;background:none;border:0;color:var(--accent-2);cursor:pointer;padding:8px 0;font-size:14px;margin-bottom:12px}
    .bottom-nav{position:fixed;left:0;right:0;bottom:18px;pointer-events:none;display:flex;justify-content:center;z-index:60}
    .bottom-nav-inner{width:100%;max-width:var(--container);padding:0 18px;display:flex;align-items:center;justify-content:space-between;gap:12px;pointer-events:auto}
    .nav-group{display:flex;gap:0;align-items:center;flex:1;justify-content:space-around}
    .nav-pill{flex:1;display:flex;align-items:center;justify-content:space-between;gap:0;background:#4FB7B3;padding:10px 14px;border-radius:14px;box-shadow:var(--shadow)}
    .nav-btn{display:flex;flex-direction:column;align-items:center;gap:4px;background:transparent;border:0;padding:6px 8px;cursor:pointer;color:#fff;font-size:13px;flex:1}
    .nav-btn .icon{font-size:18px;display:block}
    .nav-btn.active{color:#fff;font-weight:600}
    .fab{width:64px;height:64px;border-radius:50%;background:linear-gradient(90deg,#ffb84d,#ff8c42);display:grid;place-items:center;color:#fff;font-size:28px;margin-top:-28px;box-shadow:0 12px 30px rgba(255,140,66,0.18);border:6px solid #4FB7B3;cursor:pointer}
    
    /* Add Item Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 20px;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background: var(--card);
      border-radius: 14px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
    }
    
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e6eef0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }
    
    .modal-close:hover {
      background: #f0f4f5;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e3e7ee;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    .form-input:focus, .form-select:focus {
      outline: 0;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(43,124,255,0.08);
    }
    
    .form-row {
      display: flex;
      gap: 12px;
    }
    
    .form-row .form-group {
      flex: 1;
    }
    
    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .btn {
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: opacity 0.2s;
    }
    
    .btn:hover {
      opacity: 0.9;
    }
    
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    
    .btn-secondary {
      background: #f0f4f5;
      color: var(--muted);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .form-message {
      margin-top: 12px;
      font-size: 13px;
      min-height: 18px;
      padding: 8px 12px;
      border-radius: 6px;
    }
    
    .form-message.error {
      color: var(--danger);
      background: rgba(217,83,79,0.08);
    }
    
    .form-message.success {
      color: var(--success);
      background: rgba(15,81,50,0.08);
    }
    
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .empty-state {
      text-align: center;
      color: var(--muted);
      padding: 60px 20px;
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-state p {
      margin: 8px 0;
      font-size: 14px;
    }
    
    /* Recipe Detail Styles */
    .recipe-detail {
      background: var(--card);
      border-radius: 14px;
      padding: 20px;
      box-shadow: var(--shadow);
    }
    
    .recipe-detail-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .recipe-detail-title {
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 8px 0;
      color: #21303b;
    }
    
    .recipe-detail-meta {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      color: var(--muted);
      font-size: 14px;
    }
    
    .recipe-detail-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .recipe-section {
      margin-bottom: 24px;
    }
    
    .recipe-section-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #f0f4f5;
    }
    
    .ingredients-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .ingredient-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      background: #f8fafb;
      border-radius: 8px;
    }
    
    .ingredient-check {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid #e3e7ee;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--success);
      cursor: pointer;
      flex-shrink: 0;
    }
    
    .ingredient-check.available {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }
    
    .ingredient-check.unavailable {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }
    
    .ingredient-details {
      flex: 1;
    }
    
    .ingredient-name {
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .ingredient-quantity {
      font-size: 13px;
      color: var(--muted);
    }
    
    .ingredient-status {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
    }
    
    .ingredient-status.available {
      background: rgba(15,81,50,0.1);
      color: var(--success);
    }
    
    .ingredient-status.unavailable {
      background: rgba(217,83,79,0.1);
      color: var(--danger);
    }
    
    .instructions-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding-left: 20px;
    }
    
    .instruction-step {
      position: relative;
      padding-left: 8px;
    }
    
    .instruction-number {
      position: absolute;
      left: -28px;
      top: 0;
      width: 20px;
      height: 20px;
      background: var(--accent);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }
    
    .recipe-cost {
      background: linear-gradient(180deg,#eaf9f9,#ffffff);
      padding: 16px;
      border-radius: 12px;
      margin-top: 20px;
    }
    
    .cost-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .cost-total {
      font-weight: 700;
      font-size: 18px;
      color: var(--success);
      border-top: 2px solid #f0f4f5;
      padding-top: 12px;
      margin-top: 12px;
    }
    
    .cook-button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(90deg,#ffb84d,#ff8c42);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      margin-top: 20px;
    }
    
    .cook-button:hover:not(:disabled) {
      transform: translateY(-2px);
    }
    
    .cook-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    @media (max-width:1000px){
      .wrap{padding:12px;flex-direction:column}
      .sidebar{width:100%}
    }
    @media (max-width:700px){
      .bottom-nav{bottom:12px}
      .fab{width:56px;height:56px;margin-top:-24px;font-size:24px}
      .nav-btn{font-size:12px}
      .form-row {
        flex-direction: column;
        gap: 16px;
      }
      .recipe-detail-title {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap" role="main" aria-label="ExpireMe Home">
    <div class="main">
      <header class="top" aria-hidden="false">
        <div class="profile">
          <div class="avatar" title="Profile" id="userAvatar">K</div>
          <div>
            <div class="greeting" id="userGreeting">Hi User</div>
            <div style="font-size:12px;color:var(--muted)">Welcome back</div>
          </div>
        </div>
        <div class="icons">
          <button class="icon-btn" title="Notifications" id="btnBell">üîî</button>
          <button class="icon-btn" title="Settings" id="btnLogout">‚öôÔ∏è</button>
        </div>
      </header>

      <!-- HOME VIEW -->
      <div id="view-home" aria-live="polite">
        <section class="hero" aria-label="Food reminder">
          <div class="text">
            <h2 id="heroTitle">Manage Your Food Items</h2>
            <p id="heroSubtitle">Add items to track their expiry dates</p>
          </div>
          <div class="thumbs" aria-hidden="true">
            <div class="thumb"><img src="https://images.unsplash.com/photo-1516100882582-96c3a05fe590?w=800&q=60&auto=format&fit=crop" alt=""></div>
            <div class="thumb"><img src="https://images.unsplash.com/photo-1505765052448-9b5a8f1d1f9b?w=800&q=60&auto=format&fit=crop" alt=""></div>
            <div class="thumb"><img src="https://images.unsplash.com/photo-1511920170033-f8396924c348?w=800&q=60&auto=format&fit=crop" alt=""></div>
          </div>
        </section>

        <section class="section-title" aria-labelledby="title-check">
          <div class="date" id="currentDate">Loading date...</div>
          <h3 id="title-check">Check Your Food Stock!</h3>
        </section>

        <nav class="stats" role="tablist" aria-label="Stock categories">
          <div class="stat active" data-type="expired" role="tab" aria-selected="true">
            <div class="num" id="expiredCount">0</div>
            <div class="label">Expired</div>
          </div>
          <div class="stat" data-type="soon" role="tab" aria-selected="false">
            <div class="num" id="soonCount">0</div>
            <div class="label">Expiring Soon</div>
          </div>
          <div class="stat" data-type="fresh" role="tab" aria-selected="false">
            <div class="num" id="freshCount">0</div>
            <div class="label">Fresh</div>
          </div>
        </nav>

        <section class="list" id="list">
          <div class="empty-state">
            <div class="icon">üì¶</div>
            <p>No items yet</p>
            <p>Add your first item to get started!</p>
          </div>
        </section>
      </div>

      <!-- STORAGE VIEW -->
      <div id="view-storage" style="display:none">
        <div style="text-align:center;margin-top:6px;color:var(--muted);font-size:13px" id="storageDate">Loading date...</div>
        <h3 style="text-align:center;margin:6px 0 10px">Your Storage</h3>

        <div class="search" role="search" aria-label="Search ingredients">
          <span>üîç</span>
          <input id="storage-search" placeholder="Search your items..." />
        </div>

        <div class="tabs" role="tablist" aria-label="Storage tabs">
          <div class="tab active" data-loc="fridge" role="tab">Fridge</div>
          <div class="tab" data-loc="freezer" role="tab">Freezer</div>
          <div class="tab" data-loc="pantry" role="tab">Pantry</div>
        </div>

        <div class="storage-list" id="storage-list">
          <div class="empty-state">
            <div class="icon">üì¶</div>
            <p>No items in this storage</p>
            <p>Add items to see them here</p>
          </div>
        </div>
      </div>

      <!-- RECIPE VIEW -->
      <div id="view-recipe" style="display:none">
        <!-- Recipe List View -->
        <div id="recipe-list-view">
          <button class="recipe-back" id="recipe-back">‚Üê Back</button>
          <h3 style="text-align:center;margin:0 0 12px">Recipes</h3>
          <div class="recipe-grid-page" id="recipe-grid">
            <div class="empty-state">
              <div class="icon">üìö</div>
              <p>Loading recipes...</p>
              <p>Checking your pantry for ingredients...</p>
            </div>
          </div>
        </div>

        <!-- Recipe Detail View -->
        <div id="recipe-detail-view" style="display:none">
          <button class="recipe-back" id="recipe-detail-back">‚Üê Back to Recipes</button>
          <div class="recipe-detail" id="recipe-detail-content">
            <!-- Recipe details will be inserted here -->
          </div>
        </div>
      </div>
    </div>

    <aside class="sidebar" aria-label="Right column">
      <div class="card">
        <div class="small-title">Summary</div>
        <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
          <div>
            <div style="font-size:22px;font-weight:700" id="summaryExpired">0</div>
            <div style="font-size:12px;color:var(--muted)">Expired</div>
          </div>
          <div>
            <div style="font-size:22px;font-weight:700" id="summarySoon">0</div>
            <div style="font-size:12px;color:var(--muted)">Expiring Soon</div>
          </div>
          <div>
            <div style="font-size:22px;font-weight:700" id="summaryFresh">0</div>
            <div style="font-size:12px;color:var(--muted)">Fresh</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="small-title">Suggestions</div>
        <div style="font-size:14px;margin-bottom:8px">Try these recipes with items that are expiring soon</div>
        <div class="recipe-grid">
          <div class="recipe"><img class="rimg" src="https://images.unsplash.com/photo-1551218808-94e220e084d2?w=800&q=60&auto=format&fit=crop" alt=""> <div><div style="font-weight:600">Creamy Pancakes</div><div style="font-size:12px;color:var(--muted)">Milk ¬∑ Eggs</div></div></div>
          <div class="recipe"><img class="rimg" src="https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=800&q=60&auto=format&fit=crop" alt=""> <div><div style="font-weight:600">Berry Smoothie</div><div style="font-size:12px;color:var(--muted)">Yogurt ¬∑ Milk</div></div></div>
        </div>
      </div>

      <div class="card" style="text-align:center">
        <div class="small-title">Quick Actions</div>
        <button style="background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer" id="scanItemBtn">Scan Item</button>
      </div>
    </aside>
  </div>

  <!-- ADD ITEM MODAL -->
  <div class="modal-overlay" id="addItemModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Add New Item</h2>
        <button class="modal-close" id="modalClose">√ó</button>
      </div>
      <div class="modal-body">
        <form id="addItemForm">
          <div class="form-group">
            <label class="form-label" for="itemName">Item Name</label>
            <input type="text" class="form-input" id="itemName" placeholder="e.g. Milk, Eggs, Bread" required>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="itemQuantity">Quantity</label>
              <input type="number" class="form-input" id="itemQuantity" min="1" value="1" required>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="itemUnit">Unit</label>
              <select class="form-select" id="itemUnit" required>
                <option value="pieces">Pieces</option>
                <option value="grams">Grams</option>
                <option value="kilograms">Kilograms</option>
                <option value="milliliters">Milliliters</option>
                <option value="liters">Liters</option>
                <option value="ounces">Ounces</option>
                <option value="pounds">Pounds</option>
                <option value="cups">Cups</option>
                <option value="tablespoons">Tablespoons</option>
                <option value="teaspoons">Teaspoons</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="itemLocation">Storage Location</label>
            <select class="form-select" id="itemLocation" required>
              <option value="fridge">Fridge</option>
              <option value="freezer">Freezer</option>
              <option value="pantry">Pantry</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="itemExpiry">Expiry Date</label>
            <input type="date" class="form-input" id="itemExpiry" required>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelAdd">Cancel</button>
            <button type="submit" class="btn btn-primary" id="saveItem">Add Item</button>
          </div>
          
          <div class="form-message" id="formMessage"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- BOTTOM NAVIGATION -->
  <div class="bottom-nav" role="navigation" aria-label="Main navigation">
    <div class="bottom-nav-inner">
      <div class="nav-pill">
        <div class="nav-group left">
          <button class="nav-btn active" id="nav-home" title="Home"><span class="icon">üè†</span><span class="text">Home</span></button>
          <button class="nav-btn" id="nav-storage" title="Storage"><span class="icon">üì¶</span><span class="text">Storage</span></button>
        </div>

        <button class="fab" id="nav-add" aria-label="Add item">+</button>

        <div class="nav-group right">
          <button class="nav-btn" id="nav-recipe" title="Recipe"><span class="icon">üìö</span><span class="text">Recipe</span></button>
          <button class="nav-btn" id="nav-reward" title="Reward"><span class="icon">üéÅ</span><span class="text">Reward</span></button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  // Import Firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import { 
    getFirestore, 
    collection, 
    addDoc, 
    query, 
    where, 
    orderBy, 
    onSnapshot, 
    serverTimestamp,
    deleteDoc,
    doc,
    updateDoc,
    getDoc,
    getDocs,
    setDoc
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBzKv3EIbgpJgo-Is81mBUxvFvt1RctKhk",
    authDomain: "expireme-38849.firebaseapp.com",
    projectId: "expireme-38849",
    storageBucket: "expireme-38849.firebasestorage.app",
    messagingSenderId: "405593756802",
    appId: "1:405593756802:web:ab73386c1c1816a492d09b",
    measurementId: "G-RKTKJHYQZ2"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM Elements
  const listEl = document.getElementById('list');
  const storageListEl = document.getElementById('storage-list');
  const recipeGridEl = document.getElementById('recipe-grid');
  const recipeDetailContent = document.getElementById('recipe-detail-content');
  const recipeListView = document.getElementById('recipe-list-view');
  const recipeDetailView = document.getElementById('recipe-detail-view');
  const stats = document.querySelectorAll('.stat');
  const tabEls = document.querySelectorAll('.tab');
  const storageSearch = document.getElementById('storage-search');
  const navButtons = document.querySelectorAll('.nav-btn');
  const btnBell = document.getElementById('btnBell');
  const btnLogout = document.getElementById('btnLogout');
  const userAvatar = document.getElementById('userAvatar');
  const userGreeting = document.getElementById('userGreeting');
  const currentDateEl = document.getElementById('currentDate');
  const storageDateEl = document.getElementById('storageDate');
  const expiredCountEl = document.getElementById('expiredCount');
  const soonCountEl = document.getElementById('soonCount');
  const freshCountEl = document.getElementById('freshCount');
  const summaryExpiredEl = document.getElementById('summaryExpired');
  const summarySoonEl = document.getElementById('summarySoon');
  const summaryFreshEl = document.getElementById('summaryFresh');
  const heroTitle = document.getElementById('heroTitle');
  const heroSubtitle = document.getElementById('heroSubtitle');
  const scanItemBtn = document.getElementById('scanItemBtn');
  const recipeBack = document.getElementById('recipe-back');
  const recipeDetailBack = document.getElementById('recipe-detail-back');
  
  // Add Item Modal Elements
  const addItemModal = document.getElementById('addItemModal');
  const navAdd = document.getElementById('nav-add');
  const modalClose = document.getElementById('modalClose');
  const cancelAdd = document.getElementById('cancelAdd');
  const addItemForm = document.getElementById('addItemForm');
  const formMessage = document.getElementById('formMessage');
  const itemExpiry = document.getElementById('itemExpiry');
  const saveItemBtn = document.getElementById('saveItem');

  // State
  let storageActiveLoc = 'fridge';
  let userItems = [];
  let currentUser = null;
  let unsubscribeItems = null;
  let recipes = [];
  let currentRecipeDetail = null;
  let unsubscribeRecipes = null;

  // Default recipes to upload to Firestore if none exist
  const defaultRecipes = [
    {
      id: 'recipe1',
      name: 'Creamy Pancakes',
      image: 'https://drive.google.com/uc?export=view&id=1fz24lpxjskFXj6KD9jRxyTNAFwNbVJCy',
      description: 'Fluffy pancakes with a creamy twist',
      prepTime: '15 min',
      cookTime: '20 min',
      difficulty: 'Easy',
      servings: 4,
      ingredients: [
        { name: 'flour', quantity: 2, unit: 'cups', cost: 0.50 },
        { name: 'milk', quantity: 1.5, unit: 'cups', cost: 0.75 },
        { name: 'eggs', quantity: 2, unit: 'pieces', cost: 0.60 },
        { name: 'butter', quantity: 2, unit: 'tablespoons', cost: 0.40 },
        { name: 'sugar', quantity: 2, unit: 'tablespoons', cost: 0.20 },
        { name: 'baking powder', quantity: 2, unit: 'teaspoons', cost: 0.10 }
      ],
      instructions: [
        'Mix flour, sugar, and baking powder in a bowl',
        'In another bowl, whisk milk, eggs, and melted butter',
        'Combine wet and dry ingredients, mix until smooth',
        'Heat a non-stick pan over medium heat',
        'Pour 1/4 cup batter for each pancake',
        'Cook until bubbles form, then flip and cook until golden',
        'Serve with syrup or fresh fruits'
      ],
      totalCost: 2.55
    },
    {
      id: 'recipe2',
      name: 'Berry Smoothie',
      image: 'https://drive.google.google/uc?export=view&id=1YOUR_DRIVE_FILE_ID_2',
      description: 'Refreshing berry smoothie packed with nutrients',
      prepTime: '5 min',
      cookTime: '0 min',
      difficulty: 'Very Easy',
      servings: 2,
      ingredients: [
        { name: 'yogurt', quantity: 1, unit: 'cup', cost: 1.00 },
        { name: 'mixed berries', quantity: 1, unit: 'cup', cost: 1.50 },
        { name: 'milk', quantity: 1, unit: 'cup', cost: 0.50 },
        { name: 'honey', quantity: 1, unit: 'tablespoon', cost: 0.30 },
        { name: 'banana', quantity: 1, unit: 'piece', cost: 0.40 }
      ],
      instructions: [
        'Peel and slice the banana',
        'Add all ingredients to a blender',
        'Blend until smooth and creamy',
        'If too thick, add more milk',
        'Pour into glasses and serve immediately',
        'Garnish with fresh berries if desired'
      ],
      totalCost: 3.70
    },
    {
      id: 'recipe3',
      name: 'Vegetable Stir Fry',
      image: 'https://drive.googlegoogle.com/uc?export=view&id=1YOUR_DRIVE_FILE_ID_3',
      description: 'Quick and healthy vegetable stir fry',
      prepTime: '10 min',
      cookTime: '15 min',
      difficulty: 'Easy',
      servings: 3,
      ingredients: [
        { name: 'broccoli', quantity: 2, unit: 'cups', cost: 1.20 },
        { name: 'carrot', quantity: 2, unit: 'pieces', cost: 0.60 },
        { name: 'bell pepper', quantity: 1, unit: 'piece', cost: 0.80 },
        { name: 'soy sauce', quantity: 3, unit: 'tablespoons', cost: 0.45 },
        { name: 'garlic', quantity: 2, unit: 'cloves', cost: 0.20 },
        { name: 'ginger', quantity: 1, unit: 'tablespoon', cost: 0.15 },
        { name: 'onion', quantity: 1, unit: 'piece', cost: 0.40 }
      ],
      instructions: [
        'Chop all vegetables into bite-sized pieces',
        'Heat oil in a wok or large pan',
        'Add garlic and ginger, saut√© for 1 minute',
        'Add onions and cook until translucent',
        'Add carrots and broccoli, stir fry for 5 minutes',
        'Add bell peppers and cook for 3 more minutes',
        'Add soy sauce and stir well',
        'Cook for 2 more minutes and serve hot'
      ],
      totalCost: 3.80
    },
    {
      id: 'recipe4',
      name: 'Chicken Pasta',
      image: 'https://drive.google.google/uc?export=view&id=1YOUR_DRIVE_FILE_ID_4',
      description: 'Creamy chicken pasta with herbs',
      prepTime: '15 min',
      cookTime: '25 min',
      difficulty: 'Medium',
      servings: 4,
      ingredients: [
        { name: 'pasta', quantity: 250, unit: 'grams', cost: 1.50 },
        { name: 'chicken breast', quantity: 2, unit: 'pieces', cost: 4.00 },
        { name: 'cream', quantity: 1, unit: 'cup', cost: 1.20 },
        { name: 'parmesan cheese', quantity: 0.5, unit: 'cup', cost: 1.50 },
        { name: 'garlic', quantity: 3, unit: 'cloves', cost: 0.30 },
        { name: 'herbs', quantity: 2, unit: 'tablespoons', cost: 0.40 },
        { name: 'butter', quantity: 2, unit: 'tablespoons', cost: 0.40 }
      ],
      instructions: [
        'Cook pasta according to package instructions',
        'Dice chicken breast into bite-sized pieces',
        'Heat butter in a pan, add garlic',
        'Add chicken and cook until golden',
        'Pour in cream and bring to simmer',
        'Add parmesan cheese and stir until melted',
        'Add cooked pasta to the sauce',
        'Mix well, garnish with herbs and serve'
      ],
      totalCost: 9.30
    }
  ];

  // Set current date
  function updateCurrentDate() {
    const now = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const dateString = now.toLocaleDateString('en-US', options);
    currentDateEl.textContent = dateString;
    storageDateEl.textContent = dateString;
  }

  // Set minimum date for expiry to today
  const today = new Date().toISOString().split('T')[0];
  itemExpiry.min = today;

  // Function to upload default recipes to Firestore
  async function initializeDefaultRecipes() {
    try {
      console.log('Checking for existing recipes in Firestore...');
      const recipesRef = collection(db, 'recipes');
      const querySnapshot = await getDocs(recipesRef);
      
      console.log('Number of existing recipes:', querySnapshot.size);
      
      if (querySnapshot.size === 0) {
        console.log('No recipes found in Firestore. Adding default recipes...');
        
        for (const recipe of defaultRecipes) {
          try {
            // Create a document reference with the specified ID
            const recipeRef = doc(db, 'recipes', recipe.id);
            
            // Create recipe data without the id field
            const recipeData = {
              name: recipe.name,
              image: recipe.image,
              description: recipe.description,
              prepTime: recipe.prepTime,
              cookTime: recipe.cookTime,
              difficulty: recipe.difficulty,
              servings: recipe.servings,
              ingredients: recipe.ingredients,
              instructions: recipe.instructions,
              totalCost: recipe.totalCost,
              createdAt: serverTimestamp()
            };
            
            // Check if recipe already exists
            const recipeDoc = await getDoc(recipeRef);
            
            if (!recipeDoc.exists()) {
              await setDoc(recipeRef, recipeData);
              console.log(`‚úì Added recipe: ${recipe.name} (ID: ${recipe.id})`);
            } else {
              console.log(`‚ö† Recipe ${recipe.name} already exists, skipping...`);
            }
          } catch (recipeError) {
            console.error(`Error adding recipe ${recipe.name}:`, recipeError);
          }
        }
        
        console.log('Default recipes initialization completed!');
      } else {
        console.log('Recipes already exist in Firestore. Skipping initialization.');
      }
    } catch (error) {
      console.error('Error initializing default recipes:', error);
      console.error('Error details:', error.code, error.message);
    }
  }

  // Function to handle image loading with fallback
  function handleImageLoad(imgElement, imageUrl) {
    // Create a white image as fallback (SVG)
    const whiteImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9IiNmZmZmZmYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PC9zdmc+';
    
    // Set up error handler
    imgElement.onerror = function() {
      console.warn(`Failed to load image: ${imageUrl}. Using fallback.`);
      this.src = whiteImage;
      this.onerror = null; // Prevent infinite loop if fallback also fails
    };
    
    // Set the image source
    imgElement.src = imageUrl;
  }

  // Auth Check
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = 'login.html';
    } else {
      currentUser = user;
      console.log('User logged in:', user.uid, user.displayName || user.email);
      
      // Update user interface
      updateUserInterface(user);
      
      // Initialize default recipes (only if collection is empty)
      initializeDefaultRecipes();
      
      // Load user items
      loadUserItems();
      
      // Load recipes from Firestore
      loadRecipes();
    }
  });

  // Update user interface with user data
  function updateUserInterface(user) {
    if (user.displayName) {
      userGreeting.textContent = `Hi ${user.displayName}`;
      userAvatar.textContent = user.displayName.charAt(0).toUpperCase();
    } else if (user.email) {
      const userName = user.email.split('@')[0];
      userGreeting.textContent = `Hi ${userName}`;
      userAvatar.textContent = userName.charAt(0).toUpperCase();
    }
  }

  // Load user items from Firestore with real-time updates
  function loadUserItems() {
    try {
      console.log('Loading items for user:', currentUser.uid);
      const itemsRef = collection(db, 'items');
      const q = query(
        itemsRef, 
        where('userId', '==', currentUser.uid),
        orderBy('expiryDate', 'asc')
      );
      
      // Set up real-time listener
      unsubscribeItems = onSnapshot(q, 
        (snapshot) => {
          console.log('Snapshot received, docs count:', snapshot.size);
          userItems = [];
          
          if (snapshot.empty) {
            console.log('No items found for user');
            showEmptyState();
            updateRecipesAvailability();
            return;
          }
          
          snapshot.forEach((doc) => {
            const data = doc.data();
            console.log('Processing item:', doc.id, data);
            
            // Convert Firestore timestamp to Date
            let expiryDate;
            if (data.expiryDate && data.expiryDate.toDate) {
              expiryDate = data.expiryDate.toDate();
            } else if (data.expiryDate instanceof Date) {
              expiryDate = data.expiryDate;
            } else {
              console.warn('Invalid expiry date format:', data.expiryDate);
              return;
            }
            
            // Calculate days until expiry
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day
            
            const timeDiff = expiryDate.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            // Determine status based on days until expiry
            let status = 'fresh';
            if (daysDiff < 0) status = 'expired';
            else if (daysDiff <= 7) status = 'soon';
            
            const item = {
              id: doc.id,
              name: data.name || 'Unknown',
              quantity: data.quantity || 1,
              unit: data.unit || 'pieces',
              location: data.location || 'pantry',
              expiryDate: expiryDate,
              days: daysDiff,
              status: status
            };
            
            userItems.push(item);
          });
          
          console.log('Loaded items:', userItems);
          
          // Update UI with real data
          updateStats();
          renderHome('expired');
          renderStorage();
          updateHeroMessage();
          updateRecipesAvailability();
          
        }, 
        (error) => {
          console.error('Error in onSnapshot:', error);
          console.error('Error details:', error.code, error.message);
          showEmptyState();
          
          // Show error message to user
          listEl.innerHTML = `
            <div class="empty-state">
              <div class="icon">‚ùå</div>
              <p>Error loading items</p>
              <p>Please check console for details</p>
              <p style="font-size:12px">${error.message}</p>
            </div>
          `;
        }
      );
    } catch (error) {
      console.error('Error loading items:', error);
      showEmptyState();
    }
  }

  // Load recipes from Firestore
  function loadRecipes() {
    try {
      const recipesRef = collection(db, 'recipes');
      const q = query(recipesRef, orderBy('name'));
      
      // Set up real-time listener for recipes
      unsubscribeRecipes = onSnapshot(q, 
        (snapshot) => {
          console.log('Recipes snapshot received, docs count:', snapshot.size);
          recipes = [];
          
          if (snapshot.empty) {
            console.log('No recipes found in Firestore');
            recipeGridEl.innerHTML = `
              <div class="empty-state">
                <div class="icon">üìö</div>
                <p>No recipes available</p>
                <p>Add recipes to the database to get started!</p>
              </div>
            `;
            return;
          }
          
          snapshot.forEach((doc) => {
            const data = doc.data();
            const recipe = {
              id: doc.id,
              name: data.name || 'Unnamed Recipe',
              image: data.image || '',
              description: data.description || '',
              prepTime: data.prepTime || 'N/A',
              cookTime: data.cookTime || 'N/A',
              difficulty: data.difficulty || 'N/A',
              servings: data.servings || 1,
              ingredients: data.ingredients || [],
              instructions: data.instructions || [],
              totalCost: data.totalCost || 0
            };
            recipes.push(recipe);
          });
          
          console.log('Loaded recipes from Firestore:', recipes.length);
          updateRecipesAvailability();
          
        }, 
        (error) => {
          console.error('Error loading recipes:', error);
          recipeGridEl.innerHTML = `
            <div class="empty-state">
              <div class="icon">‚ùå</div>
              <p>Error loading recipes</p>
              <p>Please check console for details</p>
              <p style="font-size:12px">${error.message}</p>
            </div>
          `;
        }
      );
    } catch (error) {
      console.error('Error loading recipes:', error);
    }
  }

  // Check if user has enough ingredients for a recipe
  function checkRecipeAvailability(recipe) {
    const availability = {
      canMake: true,
      missingIngredients: [],
      availableIngredients: [],
      availableCost: 0
    };
    
    if (!recipe.ingredients || recipe.ingredients.length === 0) {
      availability.canMake = false;
      return availability;
    }
    
    recipe.ingredients.forEach(ingredient => {
      // Find matching items in user's pantry (case-insensitive partial match)
      const matchingItems = userItems.filter(item => 
        item.name.toLowerCase().includes(ingredient.name.toLowerCase()) ||
        ingredient.name.toLowerCase().includes(item.name.toLowerCase())
      );
      
      if (matchingItems.length > 0) {
        const totalQuantity = matchingItems.reduce((sum, item) => sum + item.quantity, 0);
        
        if (totalQuantity >= ingredient.quantity) {
          availability.availableIngredients.push({
            ingredient,
            available: totalQuantity,
            items: matchingItems
          });
          availability.availableCost += (ingredient.cost || 0);
        } else {
          availability.canMake = false;
          availability.missingIngredients.push({
            ingredient,
            available: totalQuantity,
            needed: ingredient.quantity
          });
        }
      } else {
        availability.canMake = false;
        availability.missingIngredients.push({
          ingredient,
          available: 0,
          needed: ingredient.quantity
        });
      }
    });
    
    return availability;
  }

  // Update recipes based on available ingredients
  function updateRecipesAvailability() {
    console.log('Updating recipes based on user items:', userItems.length);
    
    if (recipes.length === 0) {
      recipeGridEl.innerHTML = `
        <div class="empty-state">
          <div class="icon">üìö</div>
          <p>No recipes available</p>
          <p>Add recipes to the database to get started!</p>
        </div>
      `;
      return;
    }
    
    const updatedRecipes = recipes.map(recipe => {
      const availability = checkRecipeAvailability(recipe);
      return {
        ...recipe,
        availability
      };
    });
    
    // Update the recipes array with availability info
    recipes = updatedRecipes;
    renderRecipes();
  }

  // Render recipe list
  function renderRecipes() {
    console.log('Rendering recipes:', recipes.length);
    recipeGridEl.innerHTML = '';
    
    if (recipes.length === 0) {
      recipeGridEl.innerHTML = `
        <div class="empty-state">
          <div class="icon">üìö</div>
          <p>No recipes available</p>
          <p>Check back later for recipe suggestions!</p>
        </div>
      `;
      return;
    }
    
    recipes.forEach(recipe => {
      const canMake = recipe.availability ? recipe.availability.canMake : false;
      const availableCount = recipe.availability ? recipe.availability.availableIngredients.length : 0;
      const totalCount = recipe.ingredients ? recipe.ingredients.length : 0;
      
      const recipeCard = document.createElement('div');
      recipeCard.className = 'recipe-card';
      recipeCard.dataset.id = recipe.id;
      
      recipeCard.innerHTML = `
        <img class="img" src="" alt="${recipe.name}" loading="lazy">
        <div class="info">
          <div class="title">${recipe.name}</div>
          <div class="time">‚è±Ô∏è ${recipe.prepTime} ‚Ä¢ üë• ${recipe.servings} servings</div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-size:12px;color:${canMake ? 'var(--success)' : 'var(--danger)'};font-weight:600">
                ${canMake ? '‚úÖ Can Make' : '‚ùå Missing Ingredients'}
              </div>
              <div style="font-size:11px;color:var(--muted)">
                ${availableCount}/${totalCount} ingredients available
              </div>
            </div>
            <div style="font-size:18px;cursor:pointer" class="heart">${canMake ? '‚ù§Ô∏è' : 'ü§ç'}</div>
          </div>
        </div>
      `;
      
      // Handle image loading with fallback
      const imgElement = recipeCard.querySelector('.img');
      if (recipe.image && recipe.image.trim() !== '') {
        handleImageLoad(imgElement, recipe.image);
      } else {
        // Use white image if no image URL
        imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9IiNmZmZmZmYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PC9zdmc+';
      }
      
      recipeCard.addEventListener('click', () => {
        showRecipeDetail(recipe);
      });
      
      recipeGridEl.appendChild(recipeCard);
    });
  }

  // Show recipe detail view
  function showRecipeDetail(recipe) {
    currentRecipeDetail = recipe;
    recipeListView.style.display = 'none';
    recipeDetailView.style.display = 'block';
    
    const availability = recipe.availability || { canMake: false, availableIngredients: [] };
    const canMake = availability.canMake;
    
    let ingredientsHTML = '';
    if (recipe.ingredients && recipe.ingredients.length > 0) {
      recipe.ingredients.forEach((ingredient, index) => {
        const matchingItems = userItems.filter(item => 
          item.name.toLowerCase().includes(ingredient.name.toLowerCase()) ||
          ingredient.name.toLowerCase().includes(item.name.toLowerCase())
        );
        const totalAvailable = matchingItems.reduce((sum, item) => sum + item.quantity, 0);
        const hasEnough = totalAvailable >= ingredient.quantity;
        
        ingredientsHTML += `
          <div class="ingredient-item">
            <div class="ingredient-check ${hasEnough ? 'available' : 'unavailable'}">
              ${hasEnough ? '‚úì' : '‚úó'}
            </div>
            <div class="ingredient-details">
              <div class="ingredient-name">${ingredient.name.charAt(0).toUpperCase() + ingredient.name.slice(1)}</div>
              <div class="ingredient-quantity">${ingredient.quantity} ${ingredient.unit} ($${(ingredient.cost || 0).toFixed(2)})</div>
            </div>
            <div class="ingredient-status ${hasEnough ? 'available' : 'unavailable'}">
              ${hasEnough ? `Available: ${totalAvailable} ${ingredient.unit}` : `Need: ${ingredient.quantity - totalAvailable} more`}
            </div>
          </div>
        `;
      });
    } else {
      ingredientsHTML = `<p style="color:var(--muted);text-align:center">No ingredients listed for this recipe.</p>`;
    }
    
    let instructionsHTML = '';
    if (recipe.instructions && recipe.instructions.length > 0) {
      recipe.instructions.forEach((instruction, index) => {
        instructionsHTML += `
          <div class="instruction-step">
            <div class="instruction-number">${index + 1}</div>
            <div>${instruction}</div>
          </div>
        `;
      });
    } else {
      instructionsHTML = `<p style="color:var(--muted);text-align:center">No instructions available for this recipe.</p>`;
    }
    
    recipeDetailContent.innerHTML = `
      <img class="recipe-detail-image" src="" alt="${recipe.name}" loading="lazy">
      <h2 class="recipe-detail-title">${recipe.name}</h2>
      <div class="recipe-detail-meta">
        <span>‚è±Ô∏è ${recipe.prepTime || 'N/A'} prep</span>
        <span>üî• ${recipe.cookTime || 'N/A'} cook</span>
        <span>üìä ${recipe.difficulty || 'N/A'}</span>
        <span>üë• ${recipe.servings || 'N/A'} servings</span>
      </div>
      <p style="color:var(--muted);margin-bottom:20px">${recipe.description || 'No description available.'}</p>
      
      <div class="recipe-section">
        <h3 class="recipe-section-title">Ingredients</h3>
        <div class="ingredients-list">
          ${ingredientsHTML}
        </div>
      </div>
      
      <div class="recipe-section">
        <h3 class="recipe-section-title">Instructions</h3>
        <div class="instructions-list">
          ${instructionsHTML}
        </div>
      </div>
      
      <div class="recipe-cost">
        <h3 class="recipe-section-title">Cost Breakdown</h3>
        ${recipe.ingredients ? recipe.ingredients.map(ing => `
          <div class="cost-row">
            <span>${ing.name.charAt(0).toUpperCase() + ing.name.slice(1)}</span>
            <span>$${(ing.cost || 0).toFixed(2)}</span>
          </div>
        `).join('') : '<p style="color:var(--muted);text-align:center">No cost information available.</p>'}
        <div class="cost-row cost-total">
          <span>Total Estimated Cost</span>
          <span>$${recipe.totalCost ? recipe.totalCost.toFixed(2) : '0.00'}</span>
        </div>
      </div>
      
      <button class="cook-button" id="cookRecipeBtn" ${canMake ? '' : 'disabled'}>
        ${canMake ? 'üç≥ Cook This Recipe' : '‚ùå Missing Ingredients'}
      </button>
      <div id="cookMessage" style="margin-top:12px;text-align:center;font-size:13px;min-height:20px"></div>
    `;
    
    // Handle image loading with fallback
    const detailImgElement = recipeDetailContent.querySelector('.recipe-detail-image');
    if (recipe.image && recipe.image.trim() !== '') {
      handleImageLoad(detailImgElement, recipe.image);
    } else {
      // Use white image if no image URL
      detailImgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9IiNmZmZmZmYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PC9zdmc+';
    }
    
    // Add event listener to cook button
    const cookBtn = document.getElementById('cookRecipeBtn');
    if (cookBtn) {
      cookBtn.addEventListener('click', () => cookRecipe(recipe));
    }
  }

  // Cook recipe - deduct ingredients from pantry
  async function cookRecipe(recipe) {
    const cookBtn = document.getElementById('cookRecipeBtn');
    const cookMessage = document.getElementById('cookMessage');
    
    cookBtn.disabled = true;
    cookBtn.textContent = 'Cooking...';
    cookMessage.textContent = '';
    cookMessage.className = '';
    
    try {
      const updates = [];
      
      // For each ingredient, deduct from user's items
      for (const ingredient of recipe.ingredients) {
        let remainingNeeded = ingredient.quantity;
        
        // Find all matching items
        const matchingItems = userItems.filter(item => 
          item.name.toLowerCase().includes(ingredient.name.toLowerCase()) ||
          ingredient.name.toLowerCase().includes(item.name.toLowerCase())
        );
        
        // Sort by expiry date (use freshest first)
        matchingItems.sort((a, b) => a.days - b.days);
        
        for (const item of matchingItems) {
          if (remainingNeeded <= 0) break;
          
          const itemRef = doc(db, 'items', item.id);
          
          if (item.quantity > remainingNeeded) {
            // Deduct partial quantity
            const newQuantity = item.quantity - remainingNeeded;
            updates.push(updateDoc(itemRef, { quantity: newQuantity }));
            remainingNeeded = 0;
          } else {
            // Use entire item
            updates.push(deleteDoc(itemRef));
            remainingNeeded -= item.quantity;
          }
        }
      }
      
      // Execute all updates
      await Promise.all(updates);
      
      cookMessage.textContent = '‚úÖ Recipe cooked successfully! Ingredients deducted from your pantry.';
      cookMessage.style.color = 'var(--success)';
      cookBtn.textContent = 'üç≥ Cooked!';
      
      // Show success message
      setTimeout(() => {
        cookMessage.textContent = '';
        cookBtn.disabled = false;
        cookBtn.textContent = 'üç≥ Cook This Recipe';
        
        // Show recipe completion modal
        alert(`üéâ Recipe completed!\n\nYou cooked "${recipe.name}" successfully!\nTotal cost: $${recipe.totalCost ? recipe.totalCost.toFixed(2) : '0.00'}\n\nIngredients have been deducted from your pantry.`);
        
        // Go back to recipe list
        recipeDetailView.style.display = 'none';
        recipeListView.style.display = 'block';
      }, 2000);
      
    } catch (error) {
      console.error('Error cooking recipe:', error);
      cookMessage.textContent = '‚ùå Error cooking recipe. Please try again.';
      cookMessage.style.color = 'var(--danger)';
      cookBtn.disabled = false;
      cookBtn.textContent = 'üç≥ Cook This Recipe';
    }
  }

  // Show empty state
  function showEmptyState() {
    listEl.innerHTML = `
      <div class="empty-state">
        <div class="icon">üì¶</div>
        <p>No items yet</p>
        <p>Add your first item to get started!</p>
      </div>
    `;
    
    storageListEl.innerHTML = `
      <div class="empty-state">
        <div class="icon">üì¶</div>
        <p>No items in this storage</p>
        <p>Add items to see them here</p>
      </div>
    `;
    
    // Reset counts
    expiredCountEl.textContent = '0';
    soonCountEl.textContent = '0';
    freshCountEl.textContent = '0';
    summaryExpiredEl.textContent = '0';
    summarySoonEl.textContent = '0';
    summaryFreshEl.textContent = '0';
  }

  // Update hero message based on items
  function updateHeroMessage() {
    if (userItems.length === 0) {
      heroTitle.textContent = "Welcome to ExpireMe!";
      heroSubtitle.textContent = "Add your first item to start tracking expiry dates";
    } else {
      const expiringSoon = userItems.filter(item => item.status === 'soon').length;
      const expired = userItems.filter(item => item.status === 'expired').length;
      
      if (expired > 0) {
        heroTitle.textContent = `You have ${expired} expired item${expired > 1 ? 's' : ''}!`;
        heroSubtitle.textContent = "Check your expired items and consider disposing them";
      } else if (expiringSoon > 0) {
        heroTitle.textContent = `You have ${expiringSoon} item${expiringSoon > 1 ? 's' : ''} expiring soon!`;
        heroSubtitle.textContent = "Check recipes for suggestions to use them";
      } else {
        heroTitle.textContent = "All your items are fresh!";
        heroSubtitle.textContent = "Keep up the good food management";
      }
    }
  }

  // Update stats based on user items
  function updateStats() {
    const expiredCount = userItems.filter(item => item.status === 'expired').length;
    const soonCount = userItems.filter(item => item.status === 'soon').length;
    const freshCount = userItems.filter(item => item.status === 'fresh').length;
    
    console.log('Updating stats - Expired:', expiredCount, 'Soon:', soonCount, 'Fresh:', freshCount);
    
    // Update stats in the navigation
    expiredCountEl.textContent = expiredCount;
    soonCountEl.textContent = soonCount;
    freshCountEl.textContent = freshCount;
    
    // Update summary in sidebar
    summaryExpiredEl.textContent = expiredCount;
    summarySoonEl.textContent = soonCount;
    summaryFreshEl.textContent = freshCount;
  }

  // Render Functions
  function renderHome(filter='expired') {
    console.log('Rendering home with filter:', filter, 'Items:', userItems);
    listEl.innerHTML = '';
    const filtered = userItems.filter(i => filter === 'all' ? true : i.status === filter);
    
    if (!filtered.length) {
      const message = filter === 'expired' ? 'expired items' : 
                     filter === 'soon' ? 'items expiring soon' : 
                     'fresh items';
      listEl.innerHTML = `
        <div class="empty-state">
          <div class="icon">‚úÖ</div>
          <p>No ${message}</p>
          <p>All your items are ${filter === 'expired' ? 'fresh or expiring soon' : 
                                filter === 'soon' ? 'fresh or expired' : 
                                'expired or expiring soon'}!</p>
        </div>
      `;
      return;
    }
    
    filtered.forEach(it => {
      const badgeClass = it.status === 'expired' ? 'expired' : it.status === 'soon' ? 'soon' : 'fresh';
      const badgeText = it.status === 'expired' ? 'Expired' : it.status === 'soon' ? 'Expiring Soon' : 'Fresh';
      const daysText = it.days < 0 ? `${Math.abs(it.days)} days ago` : 
                      it.days === 0 ? 'Today' : 
                      `${it.days} days`;
      
      const item = document.createElement('div');
      item.className = 'item';
      item.innerHTML = `
        <div class="img">${it.name.charAt(0).toUpperCase()}</div>
        <div class="meta">
          <div class="title">${it.name}</div>
          <div class="sub">${it.quantity} ${it.unit} ‚Ä¢ ${it.location} ‚Ä¢ ${daysText}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
          <div class="badge ${badgeClass}">${badgeText}</div>
          <div class="check" data-id="${it.id}">‚úì</div>
        </div>
      `;
      listEl.appendChild(item);
      
      // Add event listener to check button
      const checkBtn = item.querySelector('.check');
      checkBtn.addEventListener('click', () => {
        handleItemCheck(it.id);
      });
    });
  }

  function renderStorage(location = storageActiveLoc, searchQuery = '') {
    console.log('Rendering storage:', location, 'Search:', searchQuery, 'Items:', userItems);
    storageListEl.innerHTML = '';
    const filtered = userItems.filter(i => 
      i.location === location && 
      i.name.toLowerCase().includes(searchQuery.toLowerCase())
    );
    
    if (!filtered.length) {
      const locationName = location === 'fridge' ? 'fridge' : 
                         location === 'freezer' ? 'freezer' : 'pantry';
      storageListEl.innerHTML = `
        <div class="empty-state">
          <div class="icon">üì¶</div>
          <p>No items in your ${locationName}</p>
          <p>Add items to see them here</p>
        </div>
      `;
      return;
    }
    
    filtered.forEach(it => {
      const daysText = it.days <= 0 ? 
        `Expired ${Math.abs(it.days)} day${Math.abs(it.days) === 1 ? '' : 's'} ago` : 
        `Expires in ${it.days} day${it.days === 1 ? '' : 's'}`;
        
      const node = document.createElement('div');
      node.className = 'storage-item';
      node.innerHTML = `
        <div class="left">
          <div class="progress">${it.name.charAt(0).toUpperCase()}</div>
          <div class="meta">
            <div style="font-weight:600">${it.name}</div>
            <div class="sub">${daysText}</div>
          </div>
        </div>
        <div class="check" data-id="${it.id}">‚úì</div>
      `;
      storageListEl.appendChild(node);
      
      // Add event listener to check button
      const checkBtn = node.querySelector('.check');
      checkBtn.addEventListener('click', () => {
        handleItemCheck(it.id);
      });
    });
  }

  // Handle item check (mark as used/remove)
  async function handleItemCheck(itemId) {
    if (confirm('Mark this item as used/consumed? This will remove it from your list.')) {
      try {
        await deleteDoc(doc(db, 'items', itemId));
        console.log('Item removed:', itemId);
      } catch (error) {
        console.error('Error removing item:', error);
        alert('Error removing item. Please try again.');
      }
    }
  }

  function showView(view) {
    document.getElementById('view-home').style.display = view === 'home' ? '' : 'none';
    document.getElementById('view-storage').style.display = view === 'storage' ? '' : 'none';
    document.getElementById('view-recipe').style.display = view === 'recipe' ? '' : 'none';
    navButtons.forEach(b => b.classList.toggle('active', b.id === `nav-${view}`));
    
    // Reset recipe views
    if (view === 'recipe') {
      recipeListView.style.display = 'block';
      recipeDetailView.style.display = 'none';
      updateRecipesAvailability();
    } else if (view === 'storage') {
      storageSearch.focus();
      renderStorage(); // Refresh storage view when switching to it
    }
  }

  // Add Item Modal Functions
  function openAddItemModal() {
    addItemModal.classList.add('active');
    document.getElementById('itemName').focus();
  }

  function closeAddItemModal() {
    addItemModal.classList.remove('active');
    addItemForm.reset();
    formMessage.textContent = '';
    formMessage.className = 'form-message';
    saveItemBtn.disabled = false;
    saveItemBtn.textContent = 'Add Item';
  }

  async function saveItem(itemData) {
    try {
      console.log('Saving item:', itemData);
      const itemsRef = collection(db, 'items');
      const docRef = await addDoc(itemsRef, {
        ...itemData,
        userId: currentUser.uid,
        createdAt: serverTimestamp()
      });
      
      console.log('Item added with ID:', docRef.id);
      
      formMessage.textContent = 'Item added successfully!';
      formMessage.className = 'form-message success';
      
      setTimeout(() => {
        closeAddItemModal();
      }, 1500);
      
      return true;
    } catch (error) {
      console.error('Error adding item:', error);
      console.error('Error code:', error.code);
      console.error('Error message:', error.message);
      
      let errorMessage = 'Error adding item. Please try again.';
      
      if (error.code === 'permission-denied') {
        errorMessage = 'Permission denied. Please check Firestore security rules.';
      } else if (error.code === 'unavailable') {
        errorMessage = 'Network error. Please check your connection.';
      }
      
      formMessage.textContent = errorMessage;
      formMessage.className = 'form-message error';
      
      saveItemBtn.disabled = false;
      saveItemBtn.textContent = 'Add Item';
      
      return false;
    }
  }

  // Initialize the application
  function initApp() {
    updateCurrentDate();
    
    // Add Item Modal Event Listeners
    navAdd.addEventListener('click', openAddItemModal);
    modalClose.addEventListener('click', closeAddItemModal);
    cancelAdd.addEventListener('click', closeAddItemModal);

    addItemForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const itemName = document.getElementById('itemName').value.trim();
      const itemQuantity = parseInt(document.getElementById('itemQuantity').value);
      const itemUnit = document.getElementById('itemUnit').value;
      const itemLocation = document.getElementById('itemLocation').value;
      const itemExpiry = document.getElementById('itemExpiry').value;
      
      if (!itemName) {
        formMessage.textContent = 'Please enter an item name.';
        formMessage.className = 'form-message error';
        return;
      }
      
      if (itemQuantity <= 0) {
        formMessage.textContent = 'Please enter a valid quantity.';
        formMessage.className = 'form-message error';
        return;
      }
      
      if (!itemExpiry) {
        formMessage.textContent = 'Please select an expiry date.';
        formMessage.className = 'form-message error';
        return;
      }
      
      // Show loading state
      saveItemBtn.disabled = true;
      saveItemBtn.textContent = 'Adding...';
      formMessage.textContent = '';
      formMessage.className = 'form-message';
      
      const itemData = {
        name: itemName,
        quantity: itemQuantity,
        unit: itemUnit,
        location: itemLocation,
        expiryDate: new Date(itemExpiry)
      };
      
      await saveItem(itemData);
    });

    // Close modal when clicking outside
    addItemModal.addEventListener('click', (e) => {
      if (e.target === addItemModal) {
        closeAddItemModal();
      }
    });

    // Recipe navigation
    recipeBack.addEventListener('click', () => showView('home'));
    recipeDetailBack.addEventListener('click', () => {
      recipeDetailView.style.display = 'none';
      recipeListView.style.display = 'block';
    });

    // Existing Event Listeners
    stats.forEach(s => {
      s.addEventListener('click', () => {
        stats.forEach(x => {
          x.classList.remove('active');
          x.setAttribute('aria-selected', 'false');
        });
        s.classList.add('active');
        s.setAttribute('aria-selected', 'true');
        renderHome(s.getAttribute('data-type'));
      });
    });

    tabEls.forEach(t => {
      t.addEventListener('click', () => {
        tabEls.forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        storageActiveLoc = t.getAttribute('data-loc');
        renderStorage(storageActiveLoc, storageSearch.value);
      });
    });

    storageSearch.addEventListener('input', () => {
      renderStorage(storageActiveLoc, storageSearch.value);
    });

    navButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        if (btn.id === 'nav-home') showView('home');
        else if (btn.id === 'nav-storage') showView('storage');
        else if (btn.id === 'nav-recipe') showView('recipe');
        else if (btn.id === 'nav-reward') alert('Rewards feature coming soon!');
      });
    });

    btnBell.addEventListener('click', () => {
      const expiredCount = userItems.filter(item => item.status === 'expired').length;
      if (expiredCount > 0) {
        alert(`You have ${expiredCount} expired item${expiredCount > 1 ? 's' : ''}. Check your expired items list.`);
      } else {
        alert('No notifications. All your items are fresh!');
      }
    });

    btnLogout.addEventListener('click', () => {
      // Unsubscribe from real-time updates before logging out
      if (unsubscribeItems) {
        unsubscribeItems();
      }
      if (unsubscribeRecipes) {
        unsubscribeRecipes();
      }
      signOut(auth).then(() => {
        window.location.href = 'login.html';
      });
    });

    scanItemBtn.addEventListener('click', () => {
      alert('Barcode scanning feature coming soon! For now, please manually add your items.');
    });
  }

  // Initialize the app when DOM is loaded
  document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>